<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Varsha Fruits and Goods - Katalog Digital</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * { font-family: 'Poppins', sans-serif; }
        :root {
            --primary-green: #22c55e;
            --primary-orange: #f97316;
            --dark-green: #15803d;
            --light-green: #dcfce7;
            --light-orange: #ffedd5;
        }
        .gradient-header { background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #f97316 100%); }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .nav-item.active { color: #22c55e; }
        .nav-item.active i { transform: scale(1.2); }
        .page { display: none; }
        .page.active { display: block; }
        .btn-primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); }
        .btn-whatsapp { background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); }
        .btn-order { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .badge { position: absolute; top: -8px; right: -8px; background: #f97316; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .modal { backdrop-filter: blur(4px); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2); }
        .category-btn.active { background: #22c55e; color: white; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #22c55e; border-radius: 4px; }
        .admin-tab.active { background: #22c55e; color: white; }
        .product-admin-card { transition: all 0.2s ease; }
        .product-admin-card:hover { background: #f0fdf4; }
        .sync-status { font-size: 10px; }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .social-icon { transition: all 0.2s ease; }
        .social-icon:hover { transform: scale(1.1); }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #dbeafe; color: #1e40af; }
        .status-shipped { background: #d1fae5; color: #065f46; }
        .status-completed { background: #dcfce7; color: #166534; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        .order-card { transition: all 0.2s ease; }
        .order-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 pb-20">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat data...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="gradient-header text-white p-4 sticky top-0 z-40 shadow-lg">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <div class="flex items-center gap-3">
                <button onclick="navigateTo('home')" class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md hover:scale-105 transition cursor-pointer overflow-hidden">
                    <img id="headerLogo" src="" alt="Logo" class="w-full h-full object-cover hidden">
                    <span id="headerLogoEmoji" class="text-2xl">üçä</span>
                </button>
                <div>
                    <h1 id="headerStoreName" class="text-xl font-bold">Varsha</h1>
                    <p class="text-xs opacity-90 flex items-center gap-1">
                        <span id="headerTagline">Fruits & Goods</span>
                        <span id="syncStatus" class="sync-status ml-2 flex items-center gap-1">
                            <span class="w-2 h-2 bg-yellow-300 rounded-full pulse-dot"></span>
                            <span class="opacity-75">Connecting...</span>
                        </span>
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showSearch()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 transition" title="Cari">
                    <i class="fas fa-search"></i>
                </button>
                <button onclick="navigateTo('home')" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 transition" title="Home">
                    <i class="fas fa-home"></i>
                </button>
                <button onclick="navigateTo('profil')" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 transition" title="Profil">
                    <i class="fas fa-store"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Customer Bar -->
    <div id="customerBar" class="bg-white border-b border-gray-200 px-4 py-2 sticky top-[76px] z-30">
        <div class="max-w-lg mx-auto flex items-center justify-between">
            <div id="customerInfo" class="flex items-center gap-2">
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-gray-400 text-sm"></i>
                </div>
                <span class="text-sm text-gray-500">Belum login</span>
            </div>
            <button onclick="showCustomerModal()" id="customerBtn" class="text-sm bg-green-500 text-white px-4 py-1.5 rounded-full font-medium hover:bg-green-600 transition">
                Masuk / Daftar
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div id="searchBar" class="hidden bg-white p-4 shadow-md sticky top-[116px] z-30">
        <div class="max-w-lg mx-auto flex gap-2">
            <input type="text" id="searchInput" placeholder="Cari produk..." class="flex-1 px-4 py-2 border border-gray-200 rounded-xl" oninput="searchProducts()">
            <button onclick="hideSearch()" class="px-4 py-2 bg-gray-100 rounded-xl text-gray-600 hover:bg-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-lg mx-auto px-4 py-4">
        <!-- Home Page -->
        <div id="homePage" class="page active fade-in">
            <!-- Hero Banner -->
            <div id="heroBanner" class="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-6 mb-6 text-white relative overflow-hidden">
                <div id="heroEmoji" class="absolute right-0 top-0 opacity-20 text-9xl">üçá</div>
                <h2 id="heroTitleDisplay" class="text-2xl font-bold mb-2 relative z-10">Selamat Datang! üëã</h2>
                <p id="heroSubtitleDisplay" class="text-sm opacity-90 mb-4 relative z-10">Buah segar & berkualitas langsung dari kebun ke rumah Anda</p>
                <button onclick="navigateTo('katalog')" class="bg-white text-green-600 px-6 py-2 rounded-full font-semibold text-sm hover:bg-gray-100 transition relative z-10">
                    Lihat Katalog <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- Categories -->
            <h3 class="text-lg font-bold text-gray-800 mb-3">Kategori</h3>
            <div class="grid grid-cols-4 gap-3 mb-6">
                <div onclick="filterByCategory('Buah')" class="bg-green-50 p-4 rounded-xl text-center cursor-pointer hover:bg-green-100 transition">
                    <span class="text-3xl">üçé</span>
                    <p class="text-xs mt-2 font-medium text-gray-700">Buah</p>
                </div>
                <div onclick="filterByCategory('Sayuran')" class="bg-orange-50 p-4 rounded-xl text-center cursor-pointer hover:bg-orange-100 transition">
                    <span class="text-3xl">ü•¨</span>
                    <p class="text-xs mt-2 font-medium text-gray-700">Sayuran</p>
                </div>
                <div onclick="filterByCategory('Bumbu')" class="bg-yellow-50 p-4 rounded-xl text-center cursor-pointer hover:bg-yellow-100 transition">
                    <span class="text-3xl">üå∂Ô∏è</span>
                    <p class="text-xs mt-2 font-medium text-gray-700">Bumbu</p>
                </div>
                <div onclick="filterByCategory('Lainnya')" class="bg-purple-50 p-4 rounded-xl text-center cursor-pointer hover:bg-purple-100 transition">
                    <span class="text-3xl">üì¶</span>
                    <p class="text-xs mt-2 font-medium text-gray-700">Lainnya</p>
                </div>
            </div>

            <!-- Featured Products -->
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold text-gray-800">Produk Populer</h3>
                <button onclick="navigateTo('katalog')" class="text-green-600 text-sm font-medium">Lihat Semua</button>
            </div>
            <div id="featuredProducts" class="grid grid-cols-2 gap-3"></div>

            <!-- Promo Banner -->
            <div id="promoBanner" class="bg-gradient-to-r from-orange-400 to-orange-500 rounded-2xl p-5 mt-6 text-white relative overflow-hidden">
                <div id="promoDecor" class="absolute right-2 bottom-2 opacity-30 text-7xl">üçä</div>
                <h3 id="promoTitle" class="font-bold text-lg mb-1 relative z-10">Buah Segar Setiap Hari!</h3>
                <p id="promoSubtitle" class="text-sm opacity-90 relative z-10">Kualitas terbaik untuk keluarga Anda</p>
            </div>
        </div>

        <!-- Katalog Page -->
        <div id="katalogPage" class="page fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Katalog Produk</h2>
            
            <div class="flex gap-2 overflow-x-auto pb-3 mb-4 scrollbar-hide">
                <button onclick="filterByCategory('all')" class="category-btn active px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">Semua</button>
                <button onclick="filterByCategory('Buah')" class="category-btn px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">üçé Buah</button>
                <button onclick="filterByCategory('Sayuran')" class="category-btn px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">ü•¨ Sayuran</button>
                <button onclick="filterByCategory('Bumbu')" class="category-btn px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">üå∂Ô∏è Bumbu</button>
                <button onclick="filterByCategory('Lainnya')" class="category-btn px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">üì¶ Lainnya</button>
            </div>

            <div id="productGrid" class="grid grid-cols-2 gap-3"></div>
        </div>

        <!-- Keranjang Page -->
        <div id="keranjangPage" class="page fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Keranjang Belanja</h2>
            <div id="cartItems"></div>
            <div id="cartEmpty" class="text-center py-12">
                <span class="text-6xl">üõí</span>
                <p class="text-gray-500 mt-4">Keranjang masih kosong</p>
                <button onclick="navigateTo('katalog')" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-full font-medium hover:bg-green-600 transition">Mulai Belanja</button>
            </div>
            <div id="cartSummary" class="hidden bg-white rounded-2xl shadow-lg p-4 mt-4">
                <div class="flex justify-between mb-4">
                    <span class="font-bold text-lg">Total Belanja</span>
                    <span id="totalPrice" class="font-bold text-lg text-green-600">Rp 0</span>
                </div>
                <button onclick="sendOrder()" class="btn-order w-full text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:shadow-lg transition">
                    <i class="fas fa-paper-plane text-lg"></i> Kirim Order
                </button>
                <p class="text-xs text-gray-500 text-center mt-2">*Ongkir akan dikonfirmasi oleh admin</p>
            </div>
        </div>

        <!-- Pesanan Page -->
        <div id="pesananPage" class="page fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pesanan Saya</h2>
            <div id="ordersList"></div>
            <div id="ordersEmpty" class="text-center py-12">
                <span class="text-6xl">üìã</span>
                <p class="text-gray-500 mt-4">Belum ada pesanan</p>
                <button onclick="navigateTo('katalog')" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-full font-medium hover:bg-green-600 transition">Mulai Belanja</button>
            </div>
        </div>

        <!-- Profil Page -->
        <div id="profilPage" class="page fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Profil Toko</h2>
            
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-4 text-center">
                <div id="profileLogoContainer" class="w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg overflow-hidden">
                    <img id="profileLogo" src="" alt="Logo" class="w-full h-full object-cover hidden">
                    <span id="profileLogoEmoji" class="text-5xl">üçä</span>
                </div>
                <h3 id="profileStoreName" class="text-2xl font-bold text-gray-800">Varsha Fruits & Goods</h3>
                <p id="profileTagline" class="text-gray-500 mt-1">Buah Segar & Berkualitas</p>
                <div class="flex justify-center gap-2 mt-3">
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium">‚úì Terpercaya</span>
                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-medium">‚≠ê Premium</span>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-4">
                <div class="p-4 border-b flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fab fa-whatsapp text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">WhatsApp</p>
                        <p id="displayWA" class="font-semibold text-gray-800">-</p>
                    </div>
                </div>
                <div class="p-4 border-b flex items-center gap-4">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-orange-600 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">Alamat</p>
                        <p id="displayAddress" class="font-semibold text-gray-800 text-sm">-</p>
                    </div>
                </div>
                <div class="p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Jam Operasional</p>
                        <p id="displayHours" class="font-semibold text-gray-800">08:00 - 21:00 WIB</p>
                    </div>
                </div>
            </div>

            <div id="socialMediaSection" class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-share-alt text-purple-500"></i> Sosial Media
                </h4>
                <div id="socialMediaLinks" class="flex flex-wrap gap-3"></div>
            </div>

            <div id="bankSection" class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-credit-card text-blue-500"></i> Rekening Pembayaran
                </h4>
                <div id="bankAccounts" class="space-y-3"></div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-4">
                <div class="flex items-center gap-3">
                    <div id="firebaseStatusIcon" class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-cloud text-yellow-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Status Database</p>
                        <p id="firebaseStatusText" class="font-semibold text-gray-800">Menghubungkan...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="page fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Panel Admin</h2>
            
            <div id="adminLogin" class="bg-white rounded-2xl shadow-lg p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-lock text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-lg">Masuk Admin</h3>
                    <p class="text-gray-500 text-sm">Masukkan PIN untuk mengakses</p>
                </div>
                <input type="password" id="adminPin" placeholder="Masukkan PIN" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-center text-2xl tracking-widest mb-4" maxlength="6">
                <button onclick="loginAdmin()" class="w-full bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">Masuk</button>
            </div>

            <div id="adminPanel" class="hidden">
                <div id="adminFirebaseStatus" class="bg-yellow-50 border border-yellow-200 rounded-xl p-3 mb-4 flex items-center gap-3">
                    <i class="fas fa-cloud text-yellow-600"></i>
                    <span class="text-sm text-yellow-800">Menghubungkan ke Firebase...</span>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onclick="switchAdminTab('orders')" class="admin-tab active px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-clipboard-list mr-1"></i> Pesanan
                    </button>
                    <button onclick="switchAdminTab('customers')" class="admin-tab px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-users mr-1"></i> Customers
                    </button>
                    <button onclick="switchAdminTab('catalog')" class="admin-tab px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-box mr-1"></i> Katalog
                    </button>
                    <button onclick="switchAdminTab('store')" class="admin-tab px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-store mr-1"></i> Toko
                    </button>
                    <button onclick="switchAdminTab('settings')" class="admin-tab px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-cog mr-1"></i> Pengaturan
                    </button>
                    <button onclick="switchAdminTab('report')" class="admin-tab px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-file-excel mr-1"></i> Report
                    </button>
                    <button onclick="switchAdminTab('hero')" class="admin-tab px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-image mr-1"></i> Hero
                    </button>
                    <button onclick="switchAdminTab('firebase')" class="admin-tab px-4 py-2 bg-gray-100 rounded-full text-sm font-medium whitespace-nowrap transition">
                        <i class="fas fa-fire mr-1"></i> Firebase
                    </button>
                </div>

                <!-- Orders Tab -->
                <div id="ordersTab">
                    <div class="flex gap-2 mb-4 overflow-x-auto">
                        <button onclick="filterOrders('all')" class="order-filter active px-3 py-1.5 bg-gray-800 text-white rounded-full text-xs font-medium">Semua</button>
                        <button onclick="filterOrders('pending')" class="order-filter px-3 py-1.5 bg-gray-100 rounded-full text-xs font-medium">Menunggu</button>
                        <button onclick="filterOrders('confirmed')" class="order-filter px-3 py-1.5 bg-gray-100 rounded-full text-xs font-medium">Dikonfirmasi</button>
                        <button onclick="filterOrders('shipped')" class="order-filter px-3 py-1.5 bg-gray-100 rounded-full text-xs font-medium">Dikirim</button>
                        <button onclick="filterOrders('completed')" class="order-filter px-3 py-1.5 bg-gray-100 rounded-full text-xs font-medium">Selesai</button>
                    </div>
                    <div id="adminOrdersList" class="space-y-3"></div>
                    <div id="adminOrdersEmpty" class="text-center py-8 hidden">
                        <span class="text-4xl">üìã</span>
                        <p class="text-gray-500 mt-2">Belum ada pesanan</p>
                    </div>
                </div>

                <!-- Customers Tab -->
                <div id="customersTab" class="hidden">
                    <div class="bg-white rounded-2xl shadow-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800">
                                <i class="fas fa-users text-blue-500 mr-2"></i> Daftar Customer
                            </h3>
                            <span id="customerCount" class="text-sm text-gray-500">0 customer</span>
                        </div>
                        <div id="adminCustomersList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Catalog Tab -->
                <div id="catalogTab" class="hidden">
                    <div class="flex gap-2 mb-4">
                        <button onclick="showAddProductModal()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:bg-green-600 transition">
                            <i class="fas fa-plus"></i> Tambah Produk
                        </button>
                        <button onclick="forceUploadProducts()" class="bg-blue-500 text-white px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:bg-blue-600 transition" title="Upload Products ke Firebase">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </button>
                    </div>

                    <!-- Bulk Upload Section -->
                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-file-import text-purple-500"></i> Upload Produk Massal
                        </h3>
                        <p class="text-xs text-gray-500 mb-3">Upload banyak produk sekaligus dari Excel atau copy-paste data</p>
                        
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Format: Nama | Harga | Satuan | Kategori | URL Gambar | Deskripsi</label>
                            <textarea id="bulkProductData" rows="4" placeholder="Contoh:
Apel Fuji	45000	kg	Buah	https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=400	Apel segar import
Jeruk Mandarin	38000	kg	Buah	https://images.unsplash.com/photo-1547514701-42782101795e?w=400	Jeruk manis tanpa biji" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-xs font-mono resize-none"></textarea>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="importFromExcel()" class="flex-1 bg-purple-500 text-white py-2 rounded-xl font-medium text-sm hover:bg-purple-600 transition flex items-center justify-center gap-2">
                                <i class="fas fa-file-excel"></i> Import Excel
                            </button>
                            <button onclick="processBulkUpload()" class="flex-1 bg-green-500 text-white py-2 rounded-xl font-medium text-sm hover:bg-green-600 transition flex items-center justify-center gap-2">
                                <i class="fas fa-upload"></i> Upload Produk
                            </button>
                        </div>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelFile(event)">
                        
                        <div class="mt-3 p-3 bg-gray-50 rounded-xl">
                            <p class="text-xs text-gray-600 font-medium mb-1">üìã Panduan Format:</p>
                            <ul class="text-xs text-gray-500 space-y-0.5">
                                <li>‚Ä¢ Pisahkan kolom dengan <strong>Tab</strong> atau copy langsung dari Excel</li>
                                <li>‚Ä¢ Kategori: <strong>Buah, Sayuran, Bumbu, Lainnya</strong></li>
                                <li>‚Ä¢ Harga dalam angka tanpa titik/koma (contoh: 45000)</li>
                                <li>‚Ä¢ URL gambar harus dimulai dengan https://</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800">
                                <i class="fas fa-list text-orange-500 mr-2"></i> Daftar Produk
                            </h3>
                            <span id="productCount" class="text-sm text-gray-500">0 produk</span>
                        </div>
                        <div id="adminProductList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Store Tab -->
                <div id="storeTab" class="hidden">
                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-image text-green-500"></i> Logo Toko
                        </h3>
                        <div class="flex items-center gap-4 mb-3">
                            <div id="adminLogoPreview" class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center overflow-hidden">
                                <span class="text-4xl">üçä</span>
                            </div>
                            <div class="flex-1">
                                <input type="url" id="storeLogo" placeholder="URL Logo (kosongkan untuk emoji)" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm mb-2">
                                <input type="text" id="storeEmoji" placeholder="Emoji: üçä" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm" maxlength="2">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-store text-blue-500"></i> Nama & Tagline
                        </h3>
                        <input type="text" id="storeName" placeholder="Nama Toko" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3">
                        <input type="text" id="storeTagline" placeholder="Tagline Toko" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-orange-500"></i> Lokasi & Jam
                        </h3>
                        <textarea id="storeAddress" rows="2" placeholder="Alamat lengkap" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3 resize-none"></textarea>
                        <input type="text" id="storeHours" placeholder="08:00 - 21:00 WIB" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-share-alt text-purple-500"></i> Sosial Media
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="socialInstagram" placeholder="Instagram" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            <input type="text" id="socialFacebook" placeholder="Facebook" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            <input type="text" id="socialTiktok" placeholder="TikTok" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            <input type="text" id="socialShopee" placeholder="Shopee" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            <input type="text" id="socialTokopedia" placeholder="Tokopedia" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            <input type="text" id="socialYoutube" placeholder="YouTube" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-credit-card text-blue-500"></i> Rekening Bank
                        </h3>
                        <div id="bankAccountsAdmin" class="space-y-3 mb-3"></div>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <input type="text" id="newBankName" placeholder="Nama Bank" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            <input type="text" id="newBankNumber" placeholder="No. Rekening" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            <input type="text" id="newBankHolder" placeholder="Atas Nama" class="px-3 py-2 border border-gray-200 rounded-xl text-sm">
                        </div>
                        <button onclick="addBankAccount()" class="w-full bg-blue-500 text-white py-2 rounded-xl font-medium text-sm hover:bg-blue-600 transition">
                            <i class="fas fa-plus mr-2"></i>Tambah Rekening
                        </button>
                    </div>

                    <button onclick="saveStoreProfile()" class="w-full bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition mb-4">
                        <i class="fas fa-save mr-2"></i> Simpan Profil Toko
                    </button>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="hidden">
                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fab fa-whatsapp text-green-500"></i> Nomor WhatsApp Admin
                        </h3>
                        <input type="text" id="waNumber" placeholder="628xxxxxxxxxx" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3">
                        <button onclick="saveWANumber()" class="w-full bg-green-500 text-white py-2 rounded-xl font-medium hover:bg-green-600 transition">
                            <i class="fas fa-save mr-2"></i>Simpan Nomor WA
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-key text-purple-500"></i> Ubah PIN Admin
                        </h3>
                        <input type="password" id="newPin" placeholder="PIN Baru (minimal 4 digit)" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3" maxlength="6">
                        <button onclick="changePin()" class="w-full bg-purple-500 text-white py-2 rounded-xl font-medium hover:bg-purple-600 transition">
                            <i class="fas fa-save mr-2"></i>Ubah PIN
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-sync text-blue-500"></i> Sinkronisasi Data
                        </h3>
                        <button onclick="uploadAllToFirebase()" class="w-full bg-blue-500 text-white py-2 rounded-xl font-medium hover:bg-blue-600 transition mb-2">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Semua ke Firebase
                        </button>
                        <button onclick="downloadFromFirebase()" class="w-full bg-green-500 text-white py-2 rounded-xl font-medium hover:bg-green-600 transition">
                            <i class="fas fa-cloud-download-alt mr-2"></i>Download dari Firebase
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-trash-alt text-red-500"></i> Hapus Data
                        </h3>
                        <p class="text-xs text-gray-500 mb-3">‚ö†Ô∏è Hati-hati! Data yang dihapus tidak dapat dikembalikan.</p>
                        
                        <button onclick="deleteAllProducts()" class="w-full bg-red-100 text-red-600 py-2 rounded-xl font-medium hover:bg-red-200 transition mb-2 flex items-center justify-center gap-2">
                            <i class="fas fa-box"></i> Hapus Semua Produk
                        </button>
                        <button onclick="deleteAllOrders()" class="w-full bg-red-100 text-red-600 py-2 rounded-xl font-medium hover:bg-red-200 transition mb-2 flex items-center justify-center gap-2">
                            <i class="fas fa-clipboard-list"></i> Hapus Semua Pesanan
                        </button>
                        <button onclick="deleteAllCustomers()" class="w-full bg-red-100 text-red-600 py-2 rounded-xl font-medium hover:bg-red-200 transition mb-2 flex items-center justify-center gap-2">
                            <i class="fas fa-users"></i> Hapus Semua Customer
                        </button>
                        <button onclick="deleteAllData()" class="w-full bg-red-500 text-white py-2 rounded-xl font-medium hover:bg-red-600 transition flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i> Hapus SEMUA Data
                        </button>
                    </div>
                </div>

                <!-- Hero Tab -->
                <div id="heroTab" class="hidden">
                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-image text-green-500"></i> Hero Banner Utama
                        </h3>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Judul Hero</label>
                            <input type="text" id="heroTitle" placeholder="Selamat Datang! üëã" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Subtitle Hero</label>
                            <input type="text" id="heroSubtitleInput" placeholder="Buah segar & berkualitas..." class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Background Gambar (Full)</label>
                            <input type="url" id="heroImageUrl" placeholder="https://..." class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm">
                        </div>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Dark Overlay: <span id="heroOverlayValue">40</span>%</label>
                            <input type="range" id="heroOverlay" min="0" max="80" value="40" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>Terang</span>
                                <span>Gelap</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">üí° Masukkan URL gambar untuk background full banner. Atur Dark Overlay agar teks tetap terbaca.</p>
                        <div id="heroPreview" class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white relative overflow-hidden mb-3 min-h-[100px] flex flex-col justify-center">
                            <div id="heroPreviewDecor" class="absolute right-0 top-0 opacity-20 text-6xl">üçá</div>
                            <h4 id="heroPreviewTitle" class="font-bold text-lg relative z-10">Selamat Datang! üëã</h4>
                            <p id="heroPreviewSubtitle" class="text-xs opacity-90 relative z-10">Buah segar & berkualitas</p>
                        </div>
                        <p class="text-xs text-gray-400">‚ö†Ô∏è Jika tidak ada gambar, akan menggunakan gradient hijau default dengan emoji üçá</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-bullhorn text-orange-500"></i> Banner Promo
                        </h3>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Judul Promo</label>
                            <input type="text" id="promoTitleInput" placeholder="Buah Segar Setiap Hari!" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Subtitle Promo</label>
                            <input type="text" id="promoSubtitleInput" placeholder="Kualitas terbaik untuk keluarga Anda" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Emoji Dekorasi</label>
                                <input type="text" id="promoEmojiInput" placeholder="üçä" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-center text-2xl" maxlength="2">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Background Gambar (Full)</label>
                                <input type="url" id="promoImageUrl" placeholder="https://..." class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm">
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">üí° Jika URL gambar diisi, gambar akan menjadi background full banner dan emoji disembunyikan</p>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Warna Gradient Dari</label>
                                <select id="promoColorFrom" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white">
                                    <option value="orange-400">Oranye</option>
                                    <option value="green-400">Hijau</option>
                                    <option value="blue-400">Biru</option>
                                    <option value="purple-400">Ungu</option>
                                    <option value="red-400">Merah</option>
                                    <option value="yellow-400">Kuning</option>
                                    <option value="pink-400">Pink</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Warna Gradient Ke</label>
                                <select id="promoColorTo" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white">
                                    <option value="orange-500">Oranye Tua</option>
                                    <option value="green-500">Hijau Tua</option>
                                    <option value="blue-500">Biru Tua</option>
                                    <option value="purple-500">Ungu Tua</option>
                                    <option value="red-500">Merah Tua</option>
                                    <option value="yellow-500">Kuning Tua</option>
                                    <option value="pink-500">Pink Tua</option>
                                </select>
                            </div>
                        </div>
                        <div id="promoPreview" class="bg-gradient-to-r from-orange-400 to-orange-500 rounded-xl p-4 text-white relative overflow-hidden">
                            <div id="promoPreviewDecor" class="absolute right-2 bottom-2 opacity-30 text-5xl">üçä</div>
                            <h4 id="promoPreviewTitle" class="font-bold relative z-10">Buah Segar Setiap Hari!</h4>
                            <p id="promoPreviewSubtitle" class="text-xs opacity-90 relative z-10">Kualitas terbaik untuk keluarga Anda</p>
                        </div>
                    </div>

                    <button onclick="saveHeroSettings()" class="w-full bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">
                        <i class="fas fa-save mr-2"></i> Simpan Pengaturan Hero
                    </button>
                </div>

                <!-- Firebase Tab -->
                <div id="firebaseTab" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            <span class="font-semibold text-green-800">Firebase Sudah Dikonfigurasi</span>
                        </div>
                        <p class="text-sm text-green-700">Aplikasi sudah terhubung otomatis ke Firebase. Konfigurasi di bawah bisa diubah jika diperlukan.</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-cog text-orange-500"></i> Konfigurasi Firebase
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">API Key</label>
                                <input type="text" id="fbApiKey" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm font-mono">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Auth Domain</label>
                                <input type="text" id="fbAuthDomain" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm font-mono">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Project ID</label>
                                <input type="text" id="fbProjectId" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm font-mono">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Storage Bucket</label>
                                <input type="text" id="fbStorageBucket" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm font-mono">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Messaging Sender ID</label>
                                <input type="text" id="fbMessagingSenderId" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm font-mono">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">App ID</label>
                                <input type="text" id="fbAppId" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm font-mono">
                            </div>
                        </div>
                        <button onclick="saveFirebaseConfig()" class="w-full mt-4 bg-orange-500 text-white py-2 rounded-xl font-medium hover:bg-orange-600 transition">
                            <i class="fas fa-save mr-2"></i>Simpan & Hubungkan Ulang
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-sync text-blue-500"></i> Sinkronisasi Data
                        </h3>
                        <button onclick="uploadAllToFirebase()" class="w-full bg-blue-500 text-white py-2 rounded-xl font-medium hover:bg-blue-600 transition mb-2">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Semua ke Firebase
                        </button>
                        <button onclick="downloadFromFirebase()" class="w-full bg-green-500 text-white py-2 rounded-xl font-medium hover:bg-green-600 transition mb-2">
                            <i class="fas fa-cloud-download-alt mr-2"></i>Download dari Firebase
                        </button>
                        <button onclick="resetToDefault()" class="w-full bg-red-100 text-red-600 py-2 rounded-xl font-medium hover:bg-red-200 transition">
                            <i class="fas fa-undo mr-2"></i>Reset ke Default
                        </button>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-500"></i> Panduan Setup Firebase
                        </h4>
                        <ol class="text-xs text-gray-500 space-y-1 list-decimal list-inside">
                            <li>Buka <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500 underline">Firebase Console</a></li>
                            <li>Buat project baru atau pilih yang sudah ada</li>
                            <li>Aktifkan Firestore Database (test mode)</li>
                            <li>Daftarkan Web App dan salin konfigurasi</li>
                            <li>Masukkan konfigurasi di form di atas</li>
                        </ol>
                        <a href="FIREBASE_SETUP.md" target="_blank" class="mt-3 inline-block text-sm text-blue-500 hover:underline">
                            <i class="fas fa-external-link-alt mr-1"></i> Baca Panduan Lengkap
                        </a>
                    </div>
                </div>

                <!-- Report Tab -->
                <div id="reportTab" class="hidden">
                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-file-excel text-green-600"></i> Export Laporan Excel
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">Download laporan dalam format Excel (.xlsx)</p>
                        
                        <div class="space-y-3">
                            <button onclick="exportOrdersToExcel()" class="w-full bg-green-600 text-white py-3 rounded-xl font-medium hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-clipboard-list"></i> Export Laporan Pesanan
                            </button>
                            
                            <button onclick="exportCustomersToExcel()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-users"></i> Export Data Customer
                            </button>
                            
                            <button onclick="exportProductsToExcel()" class="w-full bg-orange-600 text-white py-3 rounded-xl font-medium hover:bg-orange-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-box"></i> Export Data Produk
                            </button>
                            
                            <button onclick="exportAllToExcel()" class="w-full bg-purple-600 text-white py-3 rounded-xl font-medium hover:bg-purple-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-file-archive"></i> Export Semua Data
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-filter text-blue-500"></i> Filter Laporan Pesanan
                        </h3>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Dari Tanggal</label>
                                <input type="date" id="reportDateFrom" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Sampai Tanggal</label>
                                <input type="date" id="reportDateTo" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Status Pesanan</label>
                            <select id="reportStatus" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm bg-white">
                                <option value="all">Semua Status</option>
                                <option value="pending">Menunggu</option>
                                <option value="confirmed">Dikonfirmasi</option>
                                <option value="shipped">Dikirim</option>
                                <option value="completed">Selesai</option>
                                <option value="cancelled">Dibatalkan</option>
                            </select>
                        </div>
                        
                        <button onclick="exportFilteredOrdersToExcel()" class="w-full bg-green-600 text-white py-2 rounded-xl font-medium hover:bg-green-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i> Download dengan Filter
                        </button>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-500"></i> Informasi
                        </h4>
                        <ul class="text-xs text-gray-500 space-y-1">
                            <li>‚Ä¢ File akan didownload dengan nama: <strong>varsha_[jenis]_[tanggal]_[waktu].xlsx</strong></li>
                            <li>‚Ä¢ Laporan pesanan berisi detail lengkap setiap order</li>
                            <li>‚Ä¢ Data customer berisi nama, nomor HP, dan alamat</li>
                            <li>‚Ä¢ Data produk berisi katalog lengkap dengan harga</li>
                        </ul>
                    </div>
                </div>

                <button onclick="logoutAdmin()" class="w-full bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600 transition mt-4">
                    <i class="fas fa-sign-out-alt mr-2"></i> Keluar
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
        <div class="max-w-lg mx-auto flex justify-around py-2">
            <button onclick="navigateTo('katalog')" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400 transition">
                <i class="fas fa-store text-xl mb-1"></i>
                <span class="text-xs">Katalog</span>
            </button>
            <button onclick="navigateTo('keranjang')" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400 transition relative">
                <i class="fas fa-shopping-cart text-xl mb-1"></i>
                <span id="cartBadge" class="badge hidden">0</span>
                <span class="text-xs">Keranjang</span>
            </button>
            <button onclick="navigateTo('pesanan')" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400 transition relative">
                <i class="fas fa-clipboard-list text-xl mb-1"></i>
                <span id="orderBadge" class="badge hidden">0</span>
                <span class="text-xs">Pesanan</span>
            </button>
            <button onclick="navigateTo('admin')" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400 transition">
                <i class="fas fa-cog text-xl mb-1"></i>
                <span class="text-xs">Admin</span>
            </button>
        </div>
    </nav>

    <!-- Customer Login/Register Modal -->
    <div id="customerModal" class="modal fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Masuk / Daftar</h3>
                <button onclick="closeCustomerModal()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>
            
            <div id="loginForm">
                <p class="text-gray-500 text-sm mb-4">Masukkan nomor HP yang terdaftar</p>
                <input type="tel" id="loginPhone" placeholder="Nomor HP (08xxx)" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3">
                <button onclick="loginCustomer()" class="w-full bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">Masuk</button>
                <p class="text-center text-sm text-gray-500 mt-4">Belum punya akun? <button onclick="showRegisterForm()" class="text-green-600 font-medium">Daftar</button></p>
            </div>
            
            <div id="registerForm" class="hidden">
                <p class="text-gray-500 text-sm mb-4">Lengkapi data untuk mendaftar</p>
                <input type="text" id="regName" placeholder="Nama Lengkap" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3">
                <input type="tel" id="regPhone" placeholder="Nomor HP (08xxx)" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3">
                <textarea id="regAddress" rows="2" placeholder="Alamat Lengkap" class="w-full px-4 py-3 border border-gray-200 rounded-xl mb-3 resize-none"></textarea>
                <button onclick="registerCustomer()" class="w-full bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">Daftar</button>
                <p class="text-center text-sm text-gray-500 mt-4">Sudah punya akun? <button onclick="showLoginForm()" class="text-green-600 font-medium">Masuk</button></p>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal fixed inset-0 bg-black/50 z-50 hidden flex items-end justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-3xl p-6 max-h-[85vh] overflow-y-auto">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Product Form Modal -->
    <div id="productFormModal" class="modal fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="formModalTitle" class="text-lg font-bold text-gray-800">Tambah Produk</h3>
                <button onclick="closeProductFormModal()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Produk *</label>
                    <input type="text" id="productName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp) *</label>
                        <input type="number" id="productPrice" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Satuan *</label>
                        <input type="text" id="productUnit" required placeholder="kg, ikat, buah" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori *</label>
                    <select id="productCategory" required class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white">
                        <option value="">Pilih Kategori</option>
                        <option value="Buah">üçé Buah</option>
                        <option value="Sayuran">ü•¨ Sayuran</option>
                        <option value="Bumbu">üå∂Ô∏è Bumbu</option>
                        <option value="Lainnya">üì¶ Lainnya</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL Gambar *</label>
                    <input type="url" id="productImage" required placeholder="https://..." class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi *</label>
                    <textarea id="productDesc" required rows="2" placeholder="Deskripsi singkat produk" class="w-full px-4 py-3 border border-gray-200 rounded-xl resize-none"></textarea>
                </div>
                <div id="imagePreview" class="mb-4 hidden">
                    <img id="previewImg" src="" alt="Preview" class="w-full h-32 object-cover rounded-xl">
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeProductFormModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200">Batal</button>
                    <button type="submit" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Detail Pesanan</h3>
                <button onclick="closeOrderDetailModal()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>
            <div id="orderDetailContent"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Produk?</h3>
            <p id="deleteProductName" class="text-gray-500 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200">Batal</button>
                <button onclick="confirmDelete()" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600">Hapus</button>
            </div>
        </div>
    </div>

    <!-- General Confirmation Modal -->
    <div id="confirmModal" class="modal fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 text-center">
            <div id="confirmIcon" class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
            </div>
            <h3 id="confirmTitle" class="text-xl font-bold text-gray-800 mb-3">Konfirmasi</h3>
            <div id="confirmMessage" class="text-gray-600 mb-6 text-left bg-gray-50 rounded-xl p-4"></div>
            <div id="confirmWarning" class="hidden bg-red-50 border border-red-200 rounded-xl p-3 mb-4 text-left">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-circle text-red-500 mt-0.5"></i>
                    <p id="confirmWarningText" class="text-sm text-red-700"></p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition">
                    <i class="fas fa-times mr-2"></i>Batal
                </button>
                <button id="confirmBtn" onclick="" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600 transition">
                    <i class="fas fa-check mr-2"></i>Ya, Lanjutkan
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg z-[60] hidden">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Firebase Configuration
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyAyjpmryzBQfuTM8wT4eC0Ybm0VALM8_Uw",
            authDomain: "varsha-catalog.firebaseapp.com",
            projectId: "varsha-catalog",
            storageBucket: "varsha-catalog.firebasestorage.app",
            messagingSenderId: "136877159588",
            appId: "1:136877159588:web:cc881aae2da44c5cce6231"
        };

        // Default Products
        const defaultProducts = [
            // BUAH (8 produk)
            { id: 1, name: "Apel Fuji Premium", price: 45000, unit: "kg", category: "Buah", image: "https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=400", desc: "Apel Fuji segar import dari Jepang, manis dan renyah" },
            { id: 2, name: "Jeruk Mandarin", price: 38000, unit: "kg", category: "Buah", image: "https://images.unsplash.com/photo-1547514701-42782101795e?w=400", desc: "Jeruk mandarin manis tanpa biji, kaya vitamin C" },
            { id: 3, name: "Mangga Harum Manis", price: 35000, unit: "kg", category: "Buah", image: "https://images.unsplash.com/photo-1553279768-865429fa0078?w=400", desc: "Mangga lokal pilihan super manis dan harum" },
            { id: 4, name: "Anggur Red Globe", price: 75000, unit: "kg", category: "Buah", image: "https://images.unsplash.com/photo-1537640538966-79f369143f8f?w=400", desc: "Anggur merah segar import, manis dan berair" },
            { id: 5, name: "Pisang Cavendish", price: 28000, unit: "sisir", category: "Buah", image: "https://images.unsplash.com/photo-1603833665858-e61d17a86224?w=400", desc: "Pisang premium kualitas ekspor, matang sempurna" },
            { id: 6, name: "Semangka Merah", price: 35000, unit: "buah", category: "Buah", image: "https://images.unsplash.com/photo-1589984662646-e7b2e4f5989d?w=400", desc: "Semangka merah tanpa biji, segar dan manis" },
            { id: 7, name: "Strawberry Fresh", price: 55000, unit: "pack", category: "Buah", image: "https://images.unsplash.com/photo-1464965911861-746a04b4bca6?w=400", desc: "Strawberry segar dari dataran tinggi, manis asam segar" },
            { id: 8, name: "Alpukat Mentega", price: 40000, unit: "kg", category: "Buah", image: "https://images.unsplash.com/photo-1523049673857-eb18f1d7b578?w=400", desc: "Alpukat mentega super lembut, cocok untuk jus" },
            
            // SAYURAN (6 produk)
            { id: 9, name: "Bayam Organik", price: 8000, unit: "ikat", category: "Sayuran", image: "https://images.unsplash.com/photo-1576045057995-568f588f82fb?w=400", desc: "Bayam segar organik bebas pestisida" },
            { id: 10, name: "Brokoli Segar", price: 22000, unit: "kg", category: "Sayuran", image: "https://images.unsplash.com/photo-1459411552884-841db9b3cc2a?w=400", desc: "Brokoli hijau segar dan renyah, kaya nutrisi" },
            { id: 11, name: "Wortel Import", price: 18000, unit: "kg", category: "Sayuran", image: "https://images.unsplash.com/photo-1598170845058-32b9d6a5da37?w=400", desc: "Wortel manis import Australia, bagus untuk jus" },
            { id: 12, name: "Tomat Cherry", price: 25000, unit: "pack", category: "Sayuran", image: "https://images.unsplash.com/photo-1546470427-227c7b0f5654?w=400", desc: "Tomat cherry manis untuk salad dan garnish" },
            { id: 13, name: "Selada Romaine", price: 15000, unit: "pack", category: "Sayuran", image: "https://images.unsplash.com/photo-1622206151226-18ca2c9ab4a1?w=400", desc: "Selada romaine segar untuk salad sehat" },
            { id: 14, name: "Paprika Mix", price: 35000, unit: "pack", category: "Sayuran", image: "https://images.unsplash.com/photo-1563565375-f3fdfdbefa83?w=400", desc: "Paprika merah, kuning, hijau segar dan renyah" },
            
            // BUMBU (4 produk)
            { id: 15, name: "Cabai Merah Keriting", price: 55000, unit: "kg", category: "Bumbu", image: "https://images.unsplash.com/photo-1583119022894-919a68a3d0e3?w=400", desc: "Cabai merah keriting pedas segar pilihan" },
            { id: 16, name: "Bawang Merah", price: 38000, unit: "kg", category: "Bumbu", image: "https://images.unsplash.com/photo-1518977956812-cd3dbadaaf31?w=400", desc: "Bawang merah lokal pilihan, aroma kuat" },
            { id: 17, name: "Bawang Putih", price: 45000, unit: "kg", category: "Bumbu", image: "https://images.unsplash.com/photo-1540148426945-6cf22a6b2571?w=400", desc: "Bawang putih import kualitas super" },
            { id: 18, name: "Jahe Merah", price: 35000, unit: "kg", category: "Bumbu", image: "https://images.unsplash.com/photo-1615485290382-441e4d049cb5?w=400", desc: "Jahe merah segar untuk jamu dan masakan" },
            
            // LAINNYA (2 produk)
            { id: 19, name: "Madu Hutan Murni", price: 95000, unit: "botol", category: "Lainnya", image: "https://images.unsplash.com/photo-1587049352846-4a222e784d38?w=400", desc: "Madu murni asli hutan 500ml, kualitas premium" },
            { id: 20, name: "Telur Ayam Kampung", price: 52000, unit: "tray", category: "Lainnya", image: "https://images.unsplash.com/photo-1569288063643-5d29ad64df09?w=400", desc: "Telur ayam kampung organik 30 butir, lebih sehat" }
        ];

        const defaultStoreProfile = {
            logo: '', emoji: 'üçä', name: 'Varsha', tagline: 'Fruits & Goods',
            address: 'Jakarta, Indonesia', hours: '08:00 - 21:00 WIB',
            social: { instagram: '', facebook: '', tiktok: '', shopee: '', tokopedia: '', youtube: '' },
            banks: []
        };

        const defaultHeroSettings = {
            title: 'Selamat Datang! üëã',
            subtitle: 'Buah segar & berkualitas langsung dari kebun ke rumah Anda',
            imageUrl: '',
            overlay: 40,
            promoTitle: 'Buah Segar Setiap Hari!',
            promoSubtitle: 'Kualitas terbaik untuk keluarga Anda',
            promoEmoji: 'üçä',
            promoImageUrl: '',
            promoColorFrom: 'orange-400',
            promoColorTo: 'orange-500'
        };

        // State Variables
        let products = [];
        let customers = [];
        let orders = [];
        let currentCustomer = JSON.parse(localStorage.getItem('varshaCurrentCustomer')) || null;
        const _0x = atob('MjkwNzA3');
        let settings = JSON.parse(localStorage.getItem('varshaSettings')) || { waNumber: '6281234567890', pin: _0x };
        let storeProfile = JSON.parse(localStorage.getItem('varshaStoreProfile')) || { ...defaultStoreProfile };
        let heroSettings = JSON.parse(localStorage.getItem('varshaHeroSettings')) || { ...defaultHeroSettings };
        let firebaseConfig = JSON.parse(localStorage.getItem('varshaFirebaseConfig')) || defaultFirebaseConfig;
        let isAdminLoggedIn = false;
        let currentCategory = 'all';
        let currentOrderFilter = 'all';
        let deleteProductId = null;
        let db = null;
        let isFirebaseConnected = false;

        // Normalize phone number (628xx, 08xx, 8xx -> same number)
        function normalizePhone(phone) {
            if (!phone) return '';
            // Remove all non-digit characters
            let cleaned = phone.toString().replace(/\D/g, '');
            
            // Remove leading 62 (Indonesia country code)
            if (cleaned.startsWith('62')) {
                cleaned = cleaned.substring(2);
            }
            // Remove leading 0
            if (cleaned.startsWith('0')) {
                cleaned = cleaned.substring(1);
            }
            
            return cleaned;
        }

        // Get cart for current customer
        function getCart() {
            if (!currentCustomer) return [];
            const allCarts = JSON.parse(localStorage.getItem('varshaCarts')) || {};
            const normalizedPhone = normalizePhone(currentCustomer.phone);
            return allCarts[normalizedPhone] || [];
        }

        function saveCart(cart) {
            if (!currentCustomer) return;
            const allCarts = JSON.parse(localStorage.getItem('varshaCarts')) || {};
            const normalizedPhone = normalizePhone(currentCustomer.phone);
            allCarts[normalizedPhone] = cart;
            localStorage.setItem('varshaCarts', JSON.stringify(allCarts));
        }

        // Initialize Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                loadFromFirebase();
                return true;
            } catch (e) {
                console.error('Firebase error:', e);
                updateSyncStatus('error', 'Gagal');
                return false;
            }
        }

        async function loadFromFirebase() {
            if (!db) { loadFromLocalStorage(); return; }
            try {
                updateSyncStatus('syncing', 'Sinkronisasi...');
                
                // Load products
                const productsSnap = await db.collection('products').get();
                if (!productsSnap.empty) {
                    products = [];
                    productsSnap.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
                    products.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                } else {
                    products = [...defaultProducts];
                }

                // Load settings
                const settingsDoc = await db.collection('settings').doc('store').get();
                if (settingsDoc.exists) settings = { ...settings, ...settingsDoc.data() };

                // Load profile
                const profileDoc = await db.collection('settings').doc('profile').get();
                if (profileDoc.exists) storeProfile = { ...defaultStoreProfile, ...profileDoc.data() };

                // Load hero settings
                const heroDoc = await db.collection('settings').doc('hero').get();
                if (heroDoc.exists) heroSettings = { ...defaultHeroSettings, ...heroDoc.data() };

                // Load customers
                const customersSnap = await db.collection('customers').get();
                customers = [];
                customersSnap.forEach(doc => customers.push({ id: doc.id, ...doc.data() }));

                // Load orders
                const ordersSnap = await db.collection('orders').orderBy('createdAt', 'desc').get();
                orders = [];
                ordersSnap.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

                isFirebaseConnected = true;
                updateSyncStatus('connected', 'Terhubung');
                updateFirebaseStatusUI(true);
                
                // Auto upload default products if empty
                if (productsSnap.empty) {
                    console.log('Products empty, uploading defaults...');
                    await uploadDefaultProducts();
                }
                
                setupRealtimeListeners();
            } catch (e) {
                console.error('Load error:', e);
                updateSyncStatus('error', 'Error');
                loadFromLocalStorage();
            }
            renderAll();
        }

        function setupRealtimeListeners() {
            if (!db) return;
            
            // Products listener
            db.collection('products').onSnapshot(snap => {
                products = [];
                snap.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
                products.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                renderProducts();
                renderFeaturedProducts();
                if (isAdminLoggedIn) renderAdminProductList();
            });

            // Orders listener
            db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(snap => {
                // Clear and rebuild orders array to prevent duplicates
                const newOrders = [];
                const seenIds = new Set();
                snap.forEach(doc => {
                    if (!seenIds.has(doc.id)) {
                        seenIds.add(doc.id);
                        newOrders.push({ id: doc.id, ...doc.data() });
                    }
                });
                orders = newOrders;
                console.log('Orders updated from Firebase:', orders.length);
                
                // Update customer orders if customer is logged in
                if (currentCustomer) {
                    renderCustomerOrders();
                    updateOrderBadge();
                }
                // Update admin orders if admin is logged in
                if (isAdminLoggedIn) {
                    renderAdminOrders();
                }
            }, error => {
                console.error('Orders listener error:', error);
            });

            // Customers listener
            db.collection('customers').onSnapshot(snap => {
                customers = [];
                snap.forEach(doc => customers.push({ id: doc.id, ...doc.data() }));
                if (isAdminLoggedIn) renderAdminCustomers();
            });
        }

        function loadFromLocalStorage() {
            products = JSON.parse(localStorage.getItem('varshaProducts')) || [...defaultProducts];
            updateSyncStatus('offline', 'Offline');
            updateFirebaseStatusUI(false);
            renderAll();
        }

        async function saveToFirebase(collection, docId, data) {
            if (!db || !isFirebaseConnected) return;
            try {
                await db.collection(collection).doc(docId).set(data, { merge: true });
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        // Upload default products to Firebase
        async function uploadDefaultProducts() {
            if (!db) return;
            try {
                console.log('Uploading', defaultProducts.length, 'default products to Firebase...');
                for (const p of defaultProducts) {
                    await db.collection('products').doc(p.id.toString()).set({
                        name: p.name,
                        price: p.price,
                        unit: p.unit,
                        category: p.category,
                        image: p.image,
                        desc: p.desc
                    });
                }
                console.log('Default products uploaded successfully!');
                products = [...defaultProducts];
            } catch (e) {
                console.error('Upload default products error:', e);
            }
        }

        // Force upload current products to Firebase
        async function forceUploadProducts() {
            if (!db) {
                showToast('Firebase belum terhubung!');
                return;
            }
            try {
                showToast('Mengupload products...');
                const productsToUpload = products.length > 0 ? products : defaultProducts;
                console.log('Force uploading', productsToUpload.length, 'products...');
                
                for (const p of productsToUpload) {
                    await db.collection('products').doc(p.id.toString()).set({
                        name: p.name,
                        price: p.price,
                        unit: p.unit,
                        category: p.category,
                        image: p.image,
                        desc: p.desc
                    });
                }
                
                showToast('Products berhasil diupload! ‚úì');
                console.log('Force upload completed!');
            } catch (e) {
                console.error('Force upload error:', e);
                showToast('Gagal upload: ' + e.message);
            }
        }

        async function deleteFromFirebase(collection, docId) {
            if (!db || !isFirebaseConnected) return;
            try {
                await db.collection(collection).doc(docId).delete();
            } catch (e) {
                console.error('Delete error:', e);
            }
        }

        function updateSyncStatus(status, text) {
            const el = document.getElementById('syncStatus');
            const colors = { connected: 'bg-green-400', syncing: 'bg-blue-400', error: 'bg-red-400', offline: 'bg-gray-400' };
            el.innerHTML = `<span class="w-2 h-2 ${colors[status] || 'bg-yellow-300'} rounded-full ${status === 'syncing' ? 'pulse-dot' : ''}"></span><span class="opacity-75">${text}</span>`;
        }

        function updateFirebaseStatusUI(connected) {
            const icon = document.getElementById('firebaseStatusIcon');
            const text = document.getElementById('firebaseStatusText');
            const admin = document.getElementById('adminFirebaseStatus');
            if (connected) {
                icon.className = 'w-10 h-10 bg-green-100 rounded-full flex items-center justify-center';
                icon.innerHTML = '<i class="fas fa-cloud text-green-600"></i>';
                text.textContent = 'Terhubung ke Firebase';
                text.className = 'font-semibold text-green-600';
                admin.className = 'bg-green-50 border border-green-200 rounded-xl p-3 mb-4 flex items-center gap-3';
                admin.innerHTML = '<i class="fas fa-cloud text-green-600"></i><span class="text-sm text-green-800">Terhubung - Data tersinkronisasi</span>';
            } else {
                icon.className = 'w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center';
                icon.innerHTML = '<i class="fas fa-cloud text-yellow-600"></i>';
                text.textContent = 'Mode Offline';
                text.className = 'font-semibold text-yellow-600';
                admin.className = 'bg-yellow-50 border border-yellow-200 rounded-xl p-3 mb-4 flex items-center gap-3';
                admin.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-600"></i><span class="text-sm text-yellow-800">Mode Offline</span>';
            }
        }

        // Customer Functions
        function showCustomerModal() {
            document.getElementById('customerModal').classList.remove('hidden');
            showLoginForm();
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        async function loginCustomer() {
            const phone = document.getElementById('loginPhone').value.trim().replace(/\D/g, '');
            if (phone.length < 8) {
                showToast('Nomor HP tidak valid!');
                return;
            }

            // Normalize input phone for comparison
            const normalizedInput = normalizePhone(phone);
            
            // Find customer with matching normalized phone
            const customer = customers.find(c => normalizePhone(c.phone) === normalizedInput);
            if (customer) {
                currentCustomer = customer;
                localStorage.setItem('varshaCurrentCustomer', JSON.stringify(customer));
                closeCustomerModal();
                updateCustomerBar();
                renderCart();
                renderCustomerOrders();
                showToast(`Selamat datang, ${customer.name}! üëã`);
            } else {
                showToast('Nomor HP belum terdaftar!');
            }
        }

        async function registerCustomer() {
            const name = document.getElementById('regName').value.trim();
            const phone = document.getElementById('regPhone').value.trim().replace(/\D/g, '');
            const address = document.getElementById('regAddress').value.trim();

            if (!name || phone.length < 8 || !address) {
                showToast('Lengkapi semua data!');
                return;
            }

            // Normalize phone for comparison and storage
            const normalizedPhone = normalizePhone(phone);

            // Check if phone already exists (with normalization)
            if (customers.find(c => normalizePhone(c.phone) === normalizedPhone)) {
                showToast('Nomor HP sudah terdaftar!');
                return;
            }

            const newCustomer = {
                name,
                phone: normalizedPhone, // Store normalized phone
                address,
                createdAt: new Date().toISOString()
            };

            // Save to Firebase with normalized phone as ID
            await saveToFirebase('customers', normalizedPhone, newCustomer);
            customers.push({ id: normalizedPhone, ...newCustomer });

            currentCustomer = { id: normalizedPhone, ...newCustomer };
            localStorage.setItem('varshaCurrentCustomer', JSON.stringify(currentCustomer));

            closeCustomerModal();
            updateCustomerBar();
            showToast(`Pendaftaran berhasil! Selamat datang, ${name}! üéâ`);
        }

        function logoutCustomer() {
            currentCustomer = null;
            localStorage.removeItem('varshaCurrentCustomer');
            updateCustomerBar();
            renderCart();
            renderCustomerOrders();
            showToast('Berhasil keluar');
        }

        // Format phone for display (add 0 prefix if needed)
        function formatPhoneDisplay(phone) {
            const normalized = normalizePhone(phone);
            return '0' + normalized;
        }

        function updateCustomerBar() {
            const info = document.getElementById('customerInfo');
            const btn = document.getElementById('customerBtn');

            if (currentCustomer) {
                info.innerHTML = `
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-green-600 text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">${currentCustomer.name}</p>
                        <p class="text-xs text-gray-500">${formatPhoneDisplay(currentCustomer.phone)}</p>
                    </div>
                `;
                btn.textContent = 'Keluar';
                btn.onclick = logoutCustomer;
                btn.className = 'text-sm bg-gray-500 text-white px-4 py-1.5 rounded-full font-medium hover:bg-gray-600 transition';
            } else {
                info.innerHTML = `
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-400 text-sm"></i>
                    </div>
                    <span class="text-sm text-gray-500">Belum login</span>
                `;
                btn.textContent = 'Masuk / Daftar';
                btn.onclick = showCustomerModal;
                btn.className = 'text-sm bg-green-500 text-white px-4 py-1.5 rounded-full font-medium hover:bg-green-600 transition';
            }
        }

        // Render Functions
        function renderAll() {
            renderFeaturedProducts();
            renderProducts();
            updateCartBadge();
            updateOrderBadge();
            updateDisplayWA();
            applyStoreProfile();
            applyHeroSettings();
            updateCustomerBar();
            renderCart();
            renderCustomerOrders();
            if (isAdminLoggedIn) {
                renderAdminProductList();
                renderAdminOrders();
                renderAdminCustomers();
                loadStoreProfileToForm();
            }
        }

        function applyStoreProfile() {
            const headerLogo = document.getElementById('headerLogo');
            const headerLogoEmoji = document.getElementById('headerLogoEmoji');
            if (storeProfile.logo) {
                headerLogo.src = storeProfile.logo;
                headerLogo.classList.remove('hidden');
                headerLogoEmoji.classList.add('hidden');
            } else {
                headerLogo.classList.add('hidden');
                headerLogoEmoji.classList.remove('hidden');
                headerLogoEmoji.textContent = storeProfile.emoji || 'üçä';
            }
            document.getElementById('headerStoreName').textContent = storeProfile.name || 'Varsha';
            document.getElementById('headerTagline').textContent = storeProfile.tagline || 'Fruits & Goods';

            const profileLogo = document.getElementById('profileLogo');
            const profileLogoEmoji = document.getElementById('profileLogoEmoji');
            if (storeProfile.logo) {
                profileLogo.src = storeProfile.logo;
                profileLogo.classList.remove('hidden');
                profileLogoEmoji.classList.add('hidden');
            } else {
                profileLogo.classList.add('hidden');
                profileLogoEmoji.classList.remove('hidden');
                profileLogoEmoji.textContent = storeProfile.emoji || 'üçä';
            }
            document.getElementById('profileStoreName').textContent = `${storeProfile.name || 'Varsha'} ${storeProfile.tagline || ''}`;
            document.getElementById('profileTagline').textContent = storeProfile.tagline || 'Buah Segar & Berkualitas';
            document.getElementById('displayAddress').textContent = storeProfile.address || '-';
            document.getElementById('displayHours').textContent = storeProfile.hours || '08:00 - 21:00 WIB';

            renderSocialMedia();
            renderBankAccounts();
        }

        function renderSocialMedia() {
            const container = document.getElementById('socialMediaLinks');
            const social = storeProfile.social || {};
            let html = '';
            const config = {
                instagram: { icon: 'fab fa-instagram', color: 'bg-gradient-to-br from-purple-500 to-pink-500', url: 'https://instagram.com/' },
                facebook: { icon: 'fab fa-facebook-f', color: 'bg-blue-600', url: 'https://facebook.com/' },
                tiktok: { icon: 'fab fa-tiktok', color: 'bg-black', url: 'https://tiktok.com/@' },
                shopee: { icon: 'fas fa-shopping-bag', color: 'bg-orange-500', url: 'https://shopee.co.id/' },
                tokopedia: { icon: 'fas fa-store', color: 'bg-green-500', url: 'https://tokopedia.com/' },
                youtube: { icon: 'fab fa-youtube', color: 'bg-red-600', url: 'https://youtube.com/@' }
            };
            for (const [key, value] of Object.entries(social)) {
                if (value && config[key]) {
                    html += `<a href="${config[key].url}${value}" target="_blank" class="social-icon w-10 h-10 ${config[key].color} text-white rounded-full flex items-center justify-center"><i class="${config[key].icon}"></i></a>`;
                }
            }
            document.getElementById('socialMediaSection').classList.toggle('hidden', !html);
            container.innerHTML = html || '<p class="text-gray-500 text-sm">Belum ada sosial media</p>';
        }

        function renderBankAccounts() {
            const container = document.getElementById('bankAccounts');
            const banks = storeProfile.banks || [];
            document.getElementById('bankSection').classList.toggle('hidden', banks.length === 0);
            container.innerHTML = banks.map(bank => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-university text-blue-600"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${bank.name}</p>
                        <p class="text-sm text-gray-600">${bank.number} - ${bank.holder}</p>
                    </div>
                    <button onclick="copyToClipboard('${bank.number}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-copy"></i></button>
                </div>
            `).join('');
        }

        function renderFeaturedProducts() {
            document.getElementById('featuredProducts').innerHTML = products.slice(0, 4).map(p => createProductCard(p)).join('');
        }

        function renderProducts(list = null) {
            const container = document.getElementById('productGrid');
            let filtered = list || products;
            if (!list && currentCategory !== 'all') filtered = products.filter(p => p.category === currentCategory);
            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center py-12"><span class="text-5xl">üì¶</span><p class="text-gray-500 mt-3">Tidak ada produk</p></div>';
                return;
            }
            container.innerHTML = filtered.map(p => createProductCard(p)).join('');
        }

        function createProductCard(product) {
            return `
                <div class="product-card bg-white rounded-2xl shadow-md overflow-hidden cursor-pointer" onclick="showProductDetail('${product.id}')">
                    <div class="relative">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-32 object-cover" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                        <span class="absolute top-2 left-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">${product.category}</span>
                    </div>
                    <div class="p-3">
                        <h3 class="font-semibold text-sm text-gray-800 truncate">${product.name}</h3>
                        <p class="text-xs text-gray-500">per ${product.unit}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-bold text-green-600">Rp ${product.price.toLocaleString('id-ID')}</span>
                            <button onclick="event.stopPropagation(); addToCart('${product.id}')" class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center hover:bg-orange-600 transition"><i class="fas fa-plus text-sm"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showProductDetail(id) {
            const product = products.find(p => p.id.toString() === id.toString());
            if (!product) return;
            document.getElementById('modalContent').innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="w-full h-56 object-cover rounded-2xl mb-4">
                <span class="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full">${product.category}</span>
                <h2 class="text-xl font-bold text-gray-800 mt-2">${product.name}</h2>
                <p class="text-gray-500 text-sm mt-1">${product.desc}</p>
                <div class="flex items-baseline gap-2 mt-3">
                    <span class="text-2xl font-bold text-green-600">Rp ${product.price.toLocaleString('id-ID')}</span>
                    <span class="text-gray-500 text-sm">/ ${product.unit}</span>
                </div>
                <button onclick="addToCart('${product.id}'); closeModal()" class="w-full mt-6 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">
                    <i class="fas fa-cart-plus mr-2"></i> Tambah ke Keranjang
                </button>
            `;
            document.getElementById('productModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        // Cart Functions
        function addToCart(id) {
            if (!currentCustomer) {
                showToast('Silakan login terlebih dahulu!');
                showCustomerModal();
                return;
            }

            let cart = getCart();
            const existing = cart.find(item => item.id.toString() === id.toString());
            if (existing) existing.qty++;
            else cart.push({ id: id.toString(), qty: 1 });
            saveCart(cart);
            updateCartBadge();
            showToast('Ditambahkan ke keranjang! üõí');
        }

        function removeFromCart(id) {
            let cart = getCart();
            cart = cart.filter(item => item.id.toString() !== id.toString());
            saveCart(cart);
            updateCartBadge();
            renderCart();
        }

        function updateQty(id, delta) {
            let cart = getCart();
            const item = cart.find(item => item.id.toString() === id.toString());
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) { removeFromCart(id); return; }
            }
            saveCart(cart);
            renderCart();
        }

        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            const cart = getCart();
            const total = cart.reduce((sum, item) => sum + item.qty, 0);
            badge.textContent = total;
            badge.classList.toggle('hidden', total === 0);
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const empty = document.getElementById('cartEmpty');
            const summary = document.getElementById('cartSummary');
            
            if (!currentCustomer) {
                container.innerHTML = '';
                empty.innerHTML = `
                    <span class="text-6xl">üîê</span>
                    <p class="text-gray-500 mt-4">Silakan login untuk melihat keranjang</p>
                    <button onclick="showCustomerModal()" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-full font-medium hover:bg-green-600 transition">Masuk / Daftar</button>
                `;
                empty.classList.remove('hidden');
                summary.classList.add('hidden');
                return;
            }

            let cart = getCart();
            cart = cart.filter(item => products.find(p => p.id.toString() === item.id.toString()));
            saveCart(cart);
            
            if (cart.length === 0) {
                container.innerHTML = '';
                empty.innerHTML = `
                    <span class="text-6xl">üõí</span>
                    <p class="text-gray-500 mt-4">Keranjang masih kosong</p>
                    <button onclick="navigateTo('katalog')" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-full font-medium hover:bg-green-600 transition">Mulai Belanja</button>
                `;
                empty.classList.remove('hidden');
                summary.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            summary.classList.remove('hidden');
            
            container.innerHTML = cart.map(item => {
                const product = products.find(p => p.id.toString() === item.id.toString());
                if (!product) return '';
                return `
                    <div class="bg-white rounded-xl shadow-md p-3 mb-3 flex gap-3">
                        <img src="${product.image}" class="w-20 h-20 object-cover rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 text-sm">${product.name}</h4>
                            <p class="text-green-600 font-bold text-sm">Rp ${product.price.toLocaleString('id-ID')}/${product.unit}</p>
                            <div class="flex items-center justify-between mt-2">
                                <div class="flex items-center gap-2">
                                    <button onclick="updateQty('${item.id}', -1)" class="w-7 h-7 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fas fa-minus text-xs"></i></button>
                                    <span class="font-semibold w-6 text-center">${item.qty}</span>
                                    <button onclick="updateQty('${item.id}', 1)" class="w-7 h-7 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600"><i class="fas fa-plus text-xs"></i></button>
                                </div>
                                <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateCartTotal();
        }

        function updateCartTotal() {
            const cart = getCart();
            const total = cart.reduce((sum, item) => {
                const product = products.find(p => p.id.toString() === item.id.toString());
                return sum + (product ? product.price * item.qty : 0);
            }, 0);
            document.getElementById('totalPrice').textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }

        // Order Functions
        async function sendOrder() {
            if (!currentCustomer) {
                showToast('Silakan login terlebih dahulu!');
                showCustomerModal();
                return;
            }

            const cart = getCart();
            if (cart.length === 0) {
                showToast('Keranjang masih kosong!');
                return;
            }

            const subtotal = cart.reduce((sum, item) => {
                const product = products.find(p => p.id.toString() === item.id.toString());
                return sum + (product ? product.price * item.qty : 0);
            }, 0);

            const orderId = 'ORD' + Date.now();
            const normalizedPhone = normalizePhone(currentCustomer.phone);
            const orderData = {
                customerId: normalizedPhone,
                customerName: currentCustomer.name,
                customerPhone: normalizedPhone,
                customerAddress: currentCustomer.address,
                items: cart.map(item => {
                    const product = products.find(p => p.id.toString() === item.id.toString());
                    return {
                        productId: item.id,
                        name: product?.name || 'Unknown',
                        price: product?.price || 0,
                        unit: product?.unit || '',
                        qty: item.qty,
                        subtotal: (product?.price || 0) * item.qty
                    };
                }),
                subtotal,
                shippingCost: 0,
                total: subtotal,
                status: 'pending',
                createdAt: new Date().toISOString(),
                confirmedAt: null,
                shippedAt: null,
                completedAt: null
            };

            try {
                // Save to Firebase
                await saveToFirebase('orders', orderId, orderData);
                
                // Note: Don't add to local array here, let Firebase listener handle it
                // This prevents duplicate entries

                // Clear cart
                saveCart([]);
                updateCartBadge();
                renderCart();

                // Notify admin via WhatsApp
                const itemsList = orderData.items.map(i => `‚Ä¢ ${i.name} (${i.qty} ${i.unit})`).join('\n');
                const message = `üõí *PESANAN BARU*\n\nID: ${orderId}\n\nüë§ *Customer:*\n${currentCustomer.name}\n${currentCustomer.phone}\n${currentCustomer.address}\n\nüì¶ *Pesanan:*\n${itemsList}\n\nüí∞ Subtotal: Rp ${subtotal.toLocaleString('id-ID')}\n\n_Silakan konfirmasi dan tambahkan ongkir_`;
                
                window.open(`https://wa.me/${settings.waNumber}?text=${encodeURIComponent(message)}`, '_blank');

                showToast('Order berhasil dikirim! üéâ');
                
                // Navigate to pesanan page
                navigateTo('pesanan');
            } catch (error) {
                console.error('Error sending order:', error);
                showToast('Gagal mengirim order. Coba lagi!');
            }
        }

        function updateOrderBadge() {
            const badge = document.getElementById('orderBadge');
            if (!badge) return;
            
            if (!currentCustomer) {
                badge.classList.add('hidden');
                return;
            }
            
            // Normalize phone number for comparison
            const currentPhone = normalizePhone(currentCustomer.phone);
            
            const customerOrders = orders.filter(o => {
                const orderPhone = normalizePhone(o.customerId || o.customerPhone || '');
                return orderPhone === currentPhone && 
                       o.status !== 'completed' && 
                       o.status !== 'cancelled';
            });
            
            badge.textContent = customerOrders.length;
            badge.classList.toggle('hidden', customerOrders.length === 0);
        }

        function renderCustomerOrders() {
            const container = document.getElementById('ordersList');
            const empty = document.getElementById('ordersEmpty');

            if (!container || !empty) return;

            if (!currentCustomer) {
                container.innerHTML = '';
                empty.innerHTML = `
                    <span class="text-6xl">üîê</span>
                    <p class="text-gray-500 mt-4">Silakan login untuk melihat pesanan</p>
                    <button onclick="showCustomerModal()" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-full font-medium hover:bg-green-600 transition">Masuk / Daftar</button>
                `;
                empty.classList.remove('hidden');
                return;
            }

            // Normalize phone number for comparison
            const currentPhone = normalizePhone(currentCustomer.phone);
            
            // Filter orders for current customer only and remove duplicates
            const seen = new Set();
            const customerOrders = orders.filter(o => {
                // Normalize order's customer phone
                const orderPhone = normalizePhone(o.customerId || o.customerPhone || '');
                
                // Check if this order belongs to current customer
                const isCurrentCustomer = orderPhone === currentPhone;
                
                if (isCurrentCustomer && !seen.has(o.id)) {
                    seen.add(o.id);
                    return true;
                }
                return false;
            });
            
            console.log('Current customer phone:', currentPhone);
            console.log('Customer orders:', customerOrders.length, 'of', orders.length, 'total orders');
            
            if (customerOrders.length === 0) {
                container.innerHTML = '';
                empty.innerHTML = `
                    <span class="text-6xl">üìã</span>
                    <p class="text-gray-500 mt-4">Belum ada pesanan</p>
                    <button onclick="navigateTo('katalog')" class="mt-4 bg-green-500 text-white px-6 py-2 rounded-full font-medium hover:bg-green-600 transition">Mulai Belanja</button>
                `;
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            
            // Sort by newest first
            const sortedOrders = [...customerOrders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = sortedOrders.map(order => `
                <div class="order-card bg-white rounded-xl shadow-md p-4 mb-3 cursor-pointer" onclick="showOrderDetail('${order.id}')">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-semibold text-gray-800">${order.id}</p>
                            <p class="text-xs text-gray-500">${formatDate(order.createdAt)}</p>
                        </div>
                        <span class="status-${order.status} px-3 py-1 rounded-full text-xs font-medium">${getStatusLabel(order.status)}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">${order.items ? order.items.length : 0} item</div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-green-600">Rp ${(order.total || 0).toLocaleString('id-ID')}</span>
                    </div>
                </div>
            `).join('');
        }

        function showOrderDetail(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const itemsList = order.items.map(item => `
                <div class="flex justify-between py-2 border-b border-gray-100">
                    <div>
                        <p class="text-sm font-medium text-gray-800">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.qty} ${item.unit} √ó Rp ${item.price.toLocaleString('id-ID')}</p>
                    </div>
                    <p class="text-sm font-medium text-gray-800">Rp ${item.subtotal.toLocaleString('id-ID')}</p>
                </div>
            `).join('');

            document.getElementById('orderDetailContent').innerHTML = `
                <div class="mb-4">
                    <span class="status-${order.status} px-3 py-1 rounded-full text-xs font-medium">${getStatusLabel(order.status)}</span>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-3 mb-4">
                    <p class="text-xs text-gray-500 mb-1">Order ID</p>
                    <p class="font-semibold text-gray-800">${order.id}</p>
                    <p class="text-xs text-gray-500 mt-2">${formatDate(order.createdAt)}</p>
                </div>

                <h4 class="font-semibold text-gray-800 mb-2">Daftar Pesanan</h4>
                <div class="bg-gray-50 rounded-xl p-3 mb-4">
                    ${itemsList}
                </div>

                <div class="bg-gray-50 rounded-xl p-3 mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-medium">Rp ${order.subtotal.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Ongkir</span>
                        <span class="font-medium">${order.shippingCost > 0 ? 'Rp ' + order.shippingCost.toLocaleString('id-ID') : 'Menunggu konfirmasi'}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-200">
                        <span class="font-bold text-gray-800">Total</span>
                        <span class="font-bold text-green-600">Rp ${order.total.toLocaleString('id-ID')}</span>
                    </div>
                </div>


            `;

            document.getElementById('orderDetailModal').classList.remove('hidden');
        }

        function closeOrderDetailModal() {
            document.getElementById('orderDetailModal').classList.add('hidden');
        }

        function getStatusLabel(status) {
            const labels = {
                pending: '‚è≥ Menunggu',
                confirmed: '‚úÖ Dikonfirmasi',
                shipped: 'üöö Dikirim',
                completed: '‚úì Selesai',
                cancelled: '‚úó Dibatalkan'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Admin Functions
        function loginAdmin() {
            if (document.getElementById('adminPin').value === settings.pin) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('adminPin').value = '';
                renderAdminOrders();
                renderAdminCustomers();
                renderAdminProductList();
                loadStoreProfileToForm();
                document.getElementById('waNumber').value = settings.waNumber;
                showToast('Login berhasil! ‚úì');
            } else {
                showToast('PIN salah!');
            }
        }

        function logoutAdmin() {
            isAdminLoggedIn = false;
            document.getElementById('adminLogin').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            showToast('Berhasil logout');
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            ['orders', 'customers', 'catalog', 'store', 'settings', 'report', 'hero', 'firebase'].forEach(t => {
                document.getElementById(t + 'Tab').classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            // Load data for specific tabs
            if (tab === 'hero') loadHeroSettingsToForm();
            if (tab === 'firebase') loadFirebaseConfigToForm();
        }

        // Admin Orders
        function filterOrders(status) {
            currentOrderFilter = status;
            document.querySelectorAll('.order-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-gray-800', 'text-white');
                btn.classList.add('bg-gray-100');
            });
            event.currentTarget.classList.add('active', 'bg-gray-800', 'text-white');
            event.currentTarget.classList.remove('bg-gray-100');
            renderAdminOrders();
        }

        function renderAdminOrders() {
            const container = document.getElementById('adminOrdersList');
            const empty = document.getElementById('adminOrdersEmpty');

            // Remove duplicates
            const seen = new Set();
            let filtered = orders.filter(o => {
                if (!seen.has(o.id)) {
                    seen.add(o.id);
                    return true;
                }
                return false;
            });
            
            if (currentOrderFilter !== 'all') {
                filtered = filtered.filter(o => o.status === currentOrderFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = filtered.map(order => `
                <div class="order-card bg-white rounded-xl shadow-md p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-semibold text-gray-800">${order.id}</p>
                            <p class="text-xs text-gray-500">${formatDate(order.createdAt)}</p>
                        </div>
                        <span class="status-${order.status} px-3 py-1 rounded-full text-xs font-medium">${getStatusLabel(order.status)}</span>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-2 mb-3">
                        <p class="font-medium text-sm text-gray-800">${order.customerName}</p>
                        <p class="text-xs text-gray-500">${formatPhoneDisplay(order.customerPhone)}</p>
                        <p class="text-xs text-gray-500">${order.customerAddress}</p>
                    </div>

                    <div class="text-xs text-gray-600 mb-2">
                        ${order.items.map(i => `${i.name} (${i.qty})`).join(', ')}
                    </div>

                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <p class="text-xs text-gray-500">Subtotal: Rp ${order.subtotal.toLocaleString('id-ID')}</p>
                            <p class="text-xs text-gray-500">Ongkir: ${order.shippingCost > 0 ? 'Rp ' + order.shippingCost.toLocaleString('id-ID') : '-'}</p>
                        </div>
                        <span class="font-bold text-green-600">Rp ${order.total.toLocaleString('id-ID')}</span>
                    </div>

                    ${order.status === 'pending' ? `
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="shipping-${order.id}" placeholder="Ongkir" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <button onclick="confirmOrder('${order.id}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600">Konfirmasi</button>
                        </div>
                    ` : ''}
                    
                    ${order.status === 'confirmed' ? `
                        <button onclick="shipOrder('${order.id}')" class="w-full bg-purple-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-purple-600">
                            <i class="fas fa-truck mr-1"></i> Tandai Dikirim
                        </button>
                    ` : ''}

                    ${order.status === 'shipped' ? `
                        <button onclick="completeOrder('${order.id}')" class="w-full bg-green-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-green-600">
                            <i class="fas fa-check mr-1"></i> Selesai
                        </button>
                    ` : ''}

                    <button onclick="chatCustomer('62${normalizePhone(order.customerPhone)}', '${order.id}')" class="w-full mt-2 bg-green-100 text-green-700 py-2 rounded-lg text-sm font-medium hover:bg-green-200">
                        <i class="fab fa-whatsapp mr-1"></i> Chat Customer
                    </button>
                </div>
            `).join('');
        }

        async function confirmOrder(orderId) {
            const shippingInput = document.getElementById(`shipping-${orderId}`);
            const shippingCost = parseInt(shippingInput?.value) || 0;

            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const total = order.subtotal + shippingCost;
            const updateData = {
                shippingCost,
                total,
                status: 'confirmed',
                confirmedAt: new Date().toISOString()
            };

            await saveToFirebase('orders', orderId, updateData);
            Object.assign(order, updateData);
            
            // Update UI
            renderAdminOrders();
            renderCustomerOrders();
            updateOrderBadge();

            // Notify customer
            const banks = storeProfile.banks || [];
            let bankInfo = '';
            if (banks.length > 0) {
                bankInfo = '\n\nüè¶ *Transfer ke:*\n' + banks.map(b => `${b.name}: ${b.number} (${b.holder})`).join('\n');
            }

            const message = `Halo ${order.customerName}! üëã\n\nPesanan Anda telah dikonfirmasi:\n\nüõí Order ID: ${orderId}\nüí∞ Subtotal: Rp ${order.subtotal.toLocaleString('id-ID')}\nüöö Ongkir: Rp ${shippingCost.toLocaleString('id-ID')}\n\nüíµ *TOTAL: Rp ${total.toLocaleString('id-ID')}*${bankInfo}\n\nSilakan lakukan pembayaran. Terima kasih! üôè`;
            window.open(`https://wa.me/${order.customerPhone}?text=${encodeURIComponent(message)}`, '_blank');

            showToast('Order dikonfirmasi! ‚úì');
        }

        async function shipOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const updateData = {
                status: 'shipped',
                shippedAt: new Date().toISOString()
            };

            await saveToFirebase('orders', orderId, updateData);
            Object.assign(order, updateData);
            
            // Update UI
            renderAdminOrders();
            renderCustomerOrders();
            updateOrderBadge();

            // Notify customer
            const message = `Halo ${order.customerName}! üöö\n\nPesanan Anda sedang dalam perjalanan!\n\nüõí Order ID: ${orderId}\n\nMohon ditunggu ya. Terima kasih! üôè`;
            window.open(`https://wa.me/${order.customerPhone}?text=${encodeURIComponent(message)}`, '_blank');

            showToast('Order ditandai dikirim! ‚úì');
        }

        async function completeOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const updateData = {
                status: 'completed',
                completedAt: new Date().toISOString()
            };

            await saveToFirebase('orders', orderId, updateData);
            Object.assign(order, updateData);
            
            // Update UI
            renderAdminOrders();
            renderCustomerOrders();
            updateOrderBadge();

            showToast('Order selesai! ‚úì');
        }

        function chatCustomer(phone, orderId) {
            const message = `Halo! Ini dari ${storeProfile.name || 'Varsha'} mengenai pesanan ${orderId}. `;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // Admin Customers
        function renderAdminCustomers() {
            const container = document.getElementById('adminCustomersList');
            document.getElementById('customerCount').textContent = `${customers.length} customer`;

            if (customers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada customer</p>';
                return;
            }

            container.innerHTML = customers.map(c => `
                <div class="flex items-center gap-3 p-3 border border-gray-100 rounded-xl">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-green-600"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-sm text-gray-800">${c.name}</p>
                        <p class="text-xs text-gray-500">${formatPhoneDisplay(c.phone)}</p>
                        <p class="text-xs text-gray-400 truncate">${c.address}</p>
                    </div>
                    <button onclick="chatCustomer('62${normalizePhone(c.phone)}', '')" class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center hover:bg-green-200">
                        <i class="fab fa-whatsapp text-sm"></i>
                    </button>
                </div>
            `).join('');
        }

        // Admin Products
        function renderAdminProductList() {
            const container = document.getElementById('adminProductList');
            document.getElementById('productCount').textContent = `${products.length} produk`;
            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada produk</p>';
                return;
            }
            container.innerHTML = products.map(p => `
                <div class="product-admin-card flex items-center gap-3 p-3 border border-gray-100 rounded-xl">
                    <img src="${p.image}" class="w-14 h-14 object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/100?text=No+Image'">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-sm text-gray-800 truncate">${p.name}</h4>
                        <p class="text-xs text-gray-500">${p.category} ‚Ä¢ Rp ${p.price.toLocaleString('id-ID')}/${p.unit}</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editProduct('${p.id}')" class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center hover:bg-blue-200"><i class="fas fa-edit text-xs"></i></button>
                        <button onclick="showDeleteModal('${p.id}')" class="w-8 h-8 bg-red-100 text-red-600 rounded-full flex items-center justify-center hover:bg-red-200"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function showAddProductModal() {
            document.getElementById('formModalTitle').textContent = 'Tambah Produk';
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('productFormModal').classList.remove('hidden');
        }

        function editProduct(id) {
            const product = products.find(p => p.id.toString() === id.toString());
            if (!product) return;
            document.getElementById('formModalTitle').textContent = 'Edit Produk';
            document.getElementById('editProductId').value = id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productUnit').value = product.unit;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productImage').value = product.image;
            document.getElementById('productDesc').value = product.desc;
            document.getElementById('previewImg').src = product.image;
            document.getElementById('imagePreview').classList.remove('hidden');
            document.getElementById('productFormModal').classList.remove('hidden');
        }

        function closeProductFormModal() {
            document.getElementById('productFormModal').classList.add('hidden');
        }

        async function saveProduct(e) {
            e.preventDefault();
            const editId = document.getElementById('editProductId').value;
            const data = {
                name: document.getElementById('productName').value.trim(),
                price: parseInt(document.getElementById('productPrice').value),
                unit: document.getElementById('productUnit').value.trim(),
                category: document.getElementById('productCategory').value,
                image: document.getElementById('productImage').value.trim(),
                desc: document.getElementById('productDesc').value.trim()
            };
            
            if (editId) {
                const idx = products.findIndex(p => p.id.toString() === editId.toString());
                if (idx !== -1) {
                    products[idx] = { ...products[idx], ...data };
                    await saveToFirebase('products', editId.toString(), data);
                }
            } else {
                const newId = products.length > 0 ? Math.max(...products.map(p => parseInt(p.id) || 0)) + 1 : 1;
                const newProduct = { id: newId.toString(), ...data };
                products.push(newProduct);
                await saveToFirebase('products', newId.toString(), data);
            }
            
            localStorage.setItem('varshaProducts', JSON.stringify(products));
            closeProductFormModal();
            renderAdminProductList();
            renderProducts();
            renderFeaturedProducts();
            showToast('Produk berhasil disimpan! ‚úì');
        }

        function showDeleteModal(id) {
            const product = products.find(p => p.id.toString() === id.toString());
            if (!product) return;
            deleteProductId = id;
            document.getElementById('deleteProductName').textContent = `"${product.name}" akan dihapus permanen`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deleteProductId = null;
        }

        // General Confirmation Modal Functions
        let confirmCallback = null;

        function showConfirmModal(options) {
            const { title, message, warning, icon, iconBg, btnText, btnClass, onConfirm } = options;
            
            document.getElementById('confirmTitle').textContent = title || 'Konfirmasi';
            document.getElementById('confirmMessage').innerHTML = message || '';
            
            const iconEl = document.getElementById('confirmIcon');
            iconEl.className = `w-20 h-20 ${iconBg || 'bg-red-100'} rounded-full flex items-center justify-center mx-auto mb-4`;
            iconEl.innerHTML = `<i class="${icon || 'fas fa-exclamation-triangle'} ${iconBg ? 'text-' + iconBg.replace('bg-', '').replace('-100', '-500') : 'text-red-500'} text-3xl"></i>`;
            
            const warningEl = document.getElementById('confirmWarning');
            if (warning) {
                warningEl.classList.remove('hidden');
                document.getElementById('confirmWarningText').textContent = warning;
            } else {
                warningEl.classList.add('hidden');
            }
            
            const btn = document.getElementById('confirmBtn');
            btn.className = `flex-1 ${btnClass || 'bg-red-500 hover:bg-red-600'} text-white py-3 rounded-xl font-semibold transition`;
            btn.innerHTML = `<i class="fas fa-check mr-2"></i>${btnText || 'Ya, Lanjutkan'}`;
            
            confirmCallback = onConfirm;
            btn.onclick = executeConfirm;
            
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        async function executeConfirm() {
            if (confirmCallback) {
                closeConfirmModal();
                await confirmCallback();
            }
        }

        async function confirmDelete() {
            if (deleteProductId) {
                await deleteFromFirebase('products', deleteProductId.toString());
                products = products.filter(p => p.id.toString() !== deleteProductId.toString());
                localStorage.setItem('varshaProducts', JSON.stringify(products));
                renderAdminProductList();
                renderProducts();
                renderFeaturedProducts();
                showToast('Produk berhasil dihapus! ‚úì');
            }
            closeDeleteModal();
        }

        // Store Profile Functions
        function loadStoreProfileToForm() {
            document.getElementById('storeLogo').value = storeProfile.logo || '';
            document.getElementById('storeEmoji').value = storeProfile.emoji || 'üçä';
            document.getElementById('storeName').value = storeProfile.name || 'Varsha';
            document.getElementById('storeTagline').value = storeProfile.tagline || 'Fruits & Goods';
            document.getElementById('storeAddress').value = storeProfile.address || '';
            document.getElementById('storeHours').value = storeProfile.hours || '08:00 - 21:00 WIB';
            
            const social = storeProfile.social || {};
            document.getElementById('socialInstagram').value = social.instagram || '';
            document.getElementById('socialFacebook').value = social.facebook || '';
            document.getElementById('socialTiktok').value = social.tiktok || '';
            document.getElementById('socialShopee').value = social.shopee || '';
            document.getElementById('socialTokopedia').value = social.tokopedia || '';
            document.getElementById('socialYoutube').value = social.youtube || '';
            
            renderBankAccountsAdmin();
        }

        function renderBankAccountsAdmin() {
            const container = document.getElementById('bankAccountsAdmin');
            const banks = storeProfile.banks || [];
            container.innerHTML = banks.length === 0 ? '<p class="text-gray-500 text-sm text-center py-2">Belum ada rekening</p>' : 
                banks.map((bank, i) => `
                    <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                        <div class="flex-1 text-sm"><span class="font-medium">${bank.name}</span> - ${bank.number} (${bank.holder})</div>
                        <button onclick="removeBankAccount(${i})" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
        }

        function addBankAccount() {
            const name = document.getElementById('newBankName').value.trim();
            const number = document.getElementById('newBankNumber').value.trim();
            const holder = document.getElementById('newBankHolder').value.trim();
            if (!name || !number || !holder) { showToast('Lengkapi semua data rekening!'); return; }
            if (!storeProfile.banks) storeProfile.banks = [];
            storeProfile.banks.push({ name, number, holder });
            document.getElementById('newBankName').value = '';
            document.getElementById('newBankNumber').value = '';
            document.getElementById('newBankHolder').value = '';
            renderBankAccountsAdmin();
            showToast('Rekening ditambahkan!');
        }

        function removeBankAccount(i) {
            storeProfile.banks.splice(i, 1);
            renderBankAccountsAdmin();
        }

        async function saveStoreProfile() {
            storeProfile.logo = document.getElementById('storeLogo').value.trim();
            storeProfile.emoji = document.getElementById('storeEmoji').value.trim() || 'üçä';
            storeProfile.name = document.getElementById('storeName').value.trim() || 'Varsha';
            storeProfile.tagline = document.getElementById('storeTagline').value.trim() || 'Fruits & Goods';
            storeProfile.address = document.getElementById('storeAddress').value.trim();
            storeProfile.hours = document.getElementById('storeHours').value.trim() || '08:00 - 21:00 WIB';
            storeProfile.social = {
                instagram: document.getElementById('socialInstagram').value.trim(),
                facebook: document.getElementById('socialFacebook').value.trim(),
                tiktok: document.getElementById('socialTiktok').value.trim(),
                shopee: document.getElementById('socialShopee').value.trim(),
                tokopedia: document.getElementById('socialTokopedia').value.trim(),
                youtube: document.getElementById('socialYoutube').value.trim()
            };
            localStorage.setItem('varshaStoreProfile', JSON.stringify(storeProfile));
            await saveToFirebase('settings', 'profile', storeProfile);
            applyStoreProfile();
            showToast('Profil toko berhasil disimpan! ‚úì');
        }

        // Settings Functions
        async function saveWANumber() {
            const wa = document.getElementById('waNumber').value.replace(/\D/g, '');
            if (wa.length < 10) { showToast('Nomor WA tidak valid!'); return; }
            settings.waNumber = wa;
            localStorage.setItem('varshaSettings', JSON.stringify(settings));
            await saveToFirebase('settings', 'store', settings);
            updateDisplayWA();
            showToast('Nomor WhatsApp berhasil disimpan! ‚úì');
        }

        function updateDisplayWA() {
            document.getElementById('displayWA').textContent = '+' + settings.waNumber.replace(/(\d{2})(\d{3})(\d{4})(\d+)/, '$1 $2-$3-$4');
        }

        async function changePin() {
            const newPin = document.getElementById('newPin').value;
            if (newPin.length < 4) { showToast('PIN minimal 4 digit!'); return; }
            settings.pin = newPin;
            localStorage.setItem('varshaSettings', JSON.stringify(settings));
            await saveToFirebase('settings', 'store', settings);
            document.getElementById('newPin').value = '';
            showToast('PIN berhasil diubah! ‚úì');
        }

        async function uploadAllToFirebase() {
            if (!db) { showToast('Firebase tidak terhubung!'); return; }
            showToast('Mengupload data...');
            const batch = db.batch();
            products.forEach(p => {
                const ref = db.collection('products').doc(p.id.toString());
                batch.set(ref, { name: p.name, price: p.price, unit: p.unit, category: p.category, image: p.image, desc: p.desc });
            });
            batch.set(db.collection('settings').doc('store'), settings);
            batch.set(db.collection('settings').doc('profile'), storeProfile);
            await batch.commit();
            showToast('Semua data berhasil diupload! ‚úì');
        }

        async function downloadFromFirebase() {
            if (!db) { showToast('Firebase tidak terhubung!'); return; }
            showToast('Mengunduh data...');
            await loadFromFirebase();
            showToast('Data berhasil diunduh! ‚úì');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('Berhasil disalin! ‚úì');
        }

        // Excel Export Functions
        function getFileName(type) {
            const now = new Date();
            const date = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const time = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
            return `varsha_${type}_${date}_${time}.xlsx`;
        }

        function exportOrdersToExcel() {
            if (orders.length === 0) {
                showToast('Tidak ada data pesanan!');
                return;
            }

            const data = orders.map(order => ({
                'Order ID': order.id,
                'Tanggal': formatDateExcel(order.createdAt),
                'Nama Customer': order.customerName || '-',
                'No. HP': order.customerPhone || '-',
                'Alamat': order.customerAddress || '-',
                'Items': order.items ? order.items.map(i => `${i.name} (${i.qty} ${i.unit})`).join(', ') : '-',
                'Subtotal': order.subtotal || 0,
                'Ongkir': order.shippingCost || 0,
                'Total': order.total || 0,
                'Status': getStatusText(order.status),
                'Dikonfirmasi': order.confirmedAt ? formatDateExcel(order.confirmedAt) : '-',
                'Dikirim': order.shippedAt ? formatDateExcel(order.shippedAt) : '-',
                'Selesai': order.completedAt ? formatDateExcel(order.completedAt) : '-'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pesanan');
            
            // Auto-fit columns
            const colWidths = Object.keys(data[0] || {}).map(key => ({ wch: Math.max(key.length, 15) }));
            ws['!cols'] = colWidths;

            XLSX.writeFile(wb, getFileName('pesanan'));
            showToast('Laporan pesanan berhasil didownload! ‚úì');
        }

        function exportFilteredOrdersToExcel() {
            const dateFrom = document.getElementById('reportDateFrom').value;
            const dateTo = document.getElementById('reportDateTo').value;
            const status = document.getElementById('reportStatus').value;

            let filteredOrders = [...orders];

            // Filter by date range
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                filteredOrders = filteredOrders.filter(o => new Date(o.createdAt) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredOrders = filteredOrders.filter(o => new Date(o.createdAt) <= toDate);
            }

            // Filter by status
            if (status !== 'all') {
                filteredOrders = filteredOrders.filter(o => o.status === status);
            }

            if (filteredOrders.length === 0) {
                showToast('Tidak ada data sesuai filter!');
                return;
            }

            const data = filteredOrders.map(order => ({
                'Order ID': order.id,
                'Tanggal': formatDateExcel(order.createdAt),
                'Nama Customer': order.customerName || '-',
                'No. HP': order.customerPhone || '-',
                'Alamat': order.customerAddress || '-',
                'Items': order.items ? order.items.map(i => `${i.name} (${i.qty} ${i.unit})`).join(', ') : '-',
                'Subtotal': order.subtotal || 0,
                'Ongkir': order.shippingCost || 0,
                'Total': order.total || 0,
                'Status': getStatusText(order.status),
                'Dikonfirmasi': order.confirmedAt ? formatDateExcel(order.confirmedAt) : '-',
                'Dikirim': order.shippedAt ? formatDateExcel(order.shippedAt) : '-',
                'Selesai': order.completedAt ? formatDateExcel(order.completedAt) : '-'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pesanan');
            
            const colWidths = Object.keys(data[0] || {}).map(key => ({ wch: Math.max(key.length, 15) }));
            ws['!cols'] = colWidths;

            XLSX.writeFile(wb, getFileName('pesanan_filtered'));
            showToast(`${filteredOrders.length} pesanan berhasil didownload! ‚úì`);
        }

        function exportCustomersToExcel() {
            if (customers.length === 0) {
                showToast('Tidak ada data customer!');
                return;
            }

            const data = customers.map((c, idx) => ({
                'No': idx + 1,
                'Nama': c.name || '-',
                'No. HP': c.phone || '-',
                'Alamat': c.address || '-',
                'Tanggal Daftar': c.createdAt ? formatDateExcel(c.createdAt) : '-'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Customers');
            
            const colWidths = Object.keys(data[0] || {}).map(key => ({ wch: Math.max(key.length, 20) }));
            ws['!cols'] = colWidths;

            XLSX.writeFile(wb, getFileName('customers'));
            showToast('Data customer berhasil didownload! ‚úì');
        }

        function exportProductsToExcel() {
            if (products.length === 0) {
                showToast('Tidak ada data produk!');
                return;
            }

            const data = products.map((p, idx) => ({
                'No': idx + 1,
                'ID Produk': p.id,
                'Nama Produk': p.name || '-',
                'Kategori': p.category || '-',
                'Harga': p.price || 0,
                'Satuan': p.unit || '-',
                'Deskripsi': p.desc || '-',
                'URL Gambar': p.image || '-'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Produk');
            
            const colWidths = Object.keys(data[0] || {}).map(key => ({ wch: Math.max(key.length, 15) }));
            ws['!cols'] = colWidths;

            XLSX.writeFile(wb, getFileName('produk'));
            showToast('Data produk berhasil didownload! ‚úì');
        }

        function exportAllToExcel() {
            const wb = XLSX.utils.book_new();

            // Orders Sheet
            if (orders.length > 0) {
                const ordersData = orders.map(order => ({
                    'Order ID': order.id,
                    'Tanggal': formatDateExcel(order.createdAt),
                    'Nama Customer': order.customerName || '-',
                    'No. HP': order.customerPhone || '-',
                    'Alamat': order.customerAddress || '-',
                    'Items': order.items ? order.items.map(i => `${i.name} (${i.qty} ${i.unit})`).join(', ') : '-',
                    'Subtotal': order.subtotal || 0,
                    'Ongkir': order.shippingCost || 0,
                    'Total': order.total || 0,
                    'Status': getStatusText(order.status)
                }));
                const wsOrders = XLSX.utils.json_to_sheet(ordersData);
                XLSX.utils.book_append_sheet(wb, wsOrders, 'Pesanan');
            }

            // Customers Sheet
            if (customers.length > 0) {
                const customersData = customers.map((c, idx) => ({
                    'No': idx + 1,
                    'Nama': c.name || '-',
                    'No. HP': c.phone || '-',
                    'Alamat': c.address || '-',
                    'Tanggal Daftar': c.createdAt ? formatDateExcel(c.createdAt) : '-'
                }));
                const wsCustomers = XLSX.utils.json_to_sheet(customersData);
                XLSX.utils.book_append_sheet(wb, wsCustomers, 'Customers');
            }

            // Products Sheet
            if (products.length > 0) {
                const productsData = products.map((p, idx) => ({
                    'No': idx + 1,
                    'ID Produk': p.id,
                    'Nama Produk': p.name || '-',
                    'Kategori': p.category || '-',
                    'Harga': p.price || 0,
                    'Satuan': p.unit || '-',
                    'Deskripsi': p.desc || '-'
                }));
                const wsProducts = XLSX.utils.json_to_sheet(productsData);
                XLSX.utils.book_append_sheet(wb, wsProducts, 'Produk');
            }

            // Summary Sheet
            const summaryData = [
                { 'Keterangan': 'Total Pesanan', 'Jumlah': orders.length },
                { 'Keterangan': 'Pesanan Menunggu', 'Jumlah': orders.filter(o => o.status === 'pending').length },
                { 'Keterangan': 'Pesanan Dikonfirmasi', 'Jumlah': orders.filter(o => o.status === 'confirmed').length },
                { 'Keterangan': 'Pesanan Dikirim', 'Jumlah': orders.filter(o => o.status === 'shipped').length },
                { 'Keterangan': 'Pesanan Selesai', 'Jumlah': orders.filter(o => o.status === 'completed').length },
                { 'Keterangan': 'Pesanan Dibatalkan', 'Jumlah': orders.filter(o => o.status === 'cancelled').length },
                { 'Keterangan': 'Total Customer', 'Jumlah': customers.length },
                { 'Keterangan': 'Total Produk', 'Jumlah': products.length },
                { 'Keterangan': 'Total Pendapatan (Selesai)', 'Jumlah': orders.filter(o => o.status === 'completed').reduce((sum, o) => sum + (o.total || 0), 0) }
            ];
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Ringkasan');

            if (wb.SheetNames.length === 0) {
                showToast('Tidak ada data untuk diexport!');
                return;
            }

            XLSX.writeFile(wb, getFileName('semua_data'));
            showToast('Semua data berhasil didownload! ‚úì');
        }

        function formatDateExcel(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('id-ID', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusText(status) {
            const labels = {
                pending: 'Menunggu',
                confirmed: 'Dikonfirmasi',
                shipped: 'Dikirim',
                completed: 'Selesai',
                cancelled: 'Dibatalkan'
            };
            return labels[status] || status;
        }

        // Hero Settings Functions
        function loadHeroSettingsToForm() {
            // Hero fields
            document.getElementById('heroTitle').value = heroSettings.title || defaultHeroSettings.title;
            document.getElementById('heroSubtitleInput').value = heroSettings.subtitle || defaultHeroSettings.subtitle;
            document.getElementById('heroImageUrl').value = heroSettings.imageUrl || '';
            document.getElementById('heroOverlay').value = heroSettings.overlay || 40;
            document.getElementById('heroOverlayValue').textContent = heroSettings.overlay || 40;
            
            // Promo fields
            document.getElementById('promoTitleInput').value = heroSettings.promoTitle || defaultHeroSettings.promoTitle;
            document.getElementById('promoSubtitleInput').value = heroSettings.promoSubtitle || defaultHeroSettings.promoSubtitle;
            document.getElementById('promoEmojiInput').value = heroSettings.promoEmoji || defaultHeroSettings.promoEmoji;
            document.getElementById('promoImageUrl').value = heroSettings.promoImageUrl || '';
            document.getElementById('promoColorFrom').value = heroSettings.promoColorFrom || 'orange-400';
            document.getElementById('promoColorTo').value = heroSettings.promoColorTo || 'orange-500';
            
            updateHeroPreview();
            
            // Add event listeners for real-time preview - Hero
            ['heroTitle', 'heroSubtitleInput', 'heroImageUrl'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateHeroPreview);
            });
            
            // Hero overlay slider
            const heroOverlaySlider = document.getElementById('heroOverlay');
            if (heroOverlaySlider) {
                heroOverlaySlider.addEventListener('input', function() {
                    document.getElementById('heroOverlayValue').textContent = this.value;
                    updateHeroPreview();
                });
            }
            
            // Add event listeners for real-time preview - Promo
            ['promoTitleInput', 'promoSubtitleInput', 'promoEmojiInput', 'promoImageUrl', 'promoColorFrom', 'promoColorTo'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateHeroPreview);
            });
        }

        function updateHeroPreview() {
            // Hero values
            const title = document.getElementById('heroTitle').value || defaultHeroSettings.title;
            const subtitle = document.getElementById('heroSubtitleInput').value || defaultHeroSettings.subtitle;
            const imageUrl = document.getElementById('heroImageUrl').value;
            const overlay = parseInt(document.getElementById('heroOverlay').value) || 40;
            const overlayOpacity = overlay / 100;
            
            // Promo values
            const promoTitle = document.getElementById('promoTitleInput').value || defaultHeroSettings.promoTitle;
            const promoSubtitle = document.getElementById('promoSubtitleInput').value || defaultHeroSettings.promoSubtitle;
            const promoEmoji = document.getElementById('promoEmojiInput').value || defaultHeroSettings.promoEmoji;
            const promoImageUrl = document.getElementById('promoImageUrl').value;
            const promoColorFrom = document.getElementById('promoColorFrom').value || 'orange-400';
            const promoColorTo = document.getElementById('promoColorTo').value || 'orange-500';
            
            // Update hero preview
            const heroPreview = document.getElementById('heroPreview');
            const heroDecor = document.getElementById('heroPreviewDecor');
            
            if (imageUrl) {
                // Full background image with dark overlay
                heroPreview.style.backgroundImage = `linear-gradient(rgba(0,0,0,${overlayOpacity}), rgba(0,0,0,${overlayOpacity})), url('${imageUrl}')`;
                heroPreview.style.backgroundSize = 'cover';
                heroPreview.style.backgroundPosition = 'center';
                heroPreview.className = 'rounded-xl p-4 text-white relative overflow-hidden mb-3 min-h-[100px] flex flex-col justify-center';
                heroDecor.style.display = 'none';
            } else {
                // Default gradient (green) when no image
                heroPreview.style.backgroundImage = '';
                heroPreview.style.backgroundSize = '';
                heroPreview.style.backgroundPosition = '';
                heroPreview.className = 'bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white relative overflow-hidden mb-3';
                heroDecor.style.display = 'block';
                heroDecor.innerHTML = 'üçá';
            }
            
            document.getElementById('heroPreviewTitle').textContent = title;
            document.getElementById('heroPreviewSubtitle').textContent = subtitle;
            
            // Update promo preview
            const promoPreview = document.getElementById('promoPreview');
            const promoDecorEl = document.getElementById('promoPreviewDecor');
            
            if (promoImageUrl) {
                // Full background image preview
                promoPreview.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.5)), url('${promoImageUrl}')`;
                promoPreview.style.backgroundSize = 'cover';
                promoPreview.style.backgroundPosition = 'center';
                promoPreview.className = 'rounded-xl p-4 text-white relative overflow-hidden min-h-[80px] flex flex-col justify-center';
                promoDecorEl.style.display = 'none';
            } else {
                // Gradient with emoji
                promoPreview.style.backgroundImage = '';
                promoPreview.style.backgroundSize = '';
                promoPreview.style.backgroundPosition = '';
                promoPreview.className = `bg-gradient-to-r from-${promoColorFrom} to-${promoColorTo} rounded-xl p-4 text-white relative overflow-hidden`;
                promoDecorEl.style.display = 'block';
                promoDecorEl.textContent = promoEmoji;
            }
            
            document.getElementById('promoPreviewTitle').textContent = promoTitle;
            document.getElementById('promoPreviewSubtitle').textContent = promoSubtitle;
        }

        async function saveHeroSettings() {
            heroSettings = {
                // Hero settings
                title: document.getElementById('heroTitle').value.trim() || defaultHeroSettings.title,
                subtitle: document.getElementById('heroSubtitleInput').value.trim() || defaultHeroSettings.subtitle,
                imageUrl: document.getElementById('heroImageUrl').value.trim(),
                overlay: parseInt(document.getElementById('heroOverlay').value) || 40,
                // Promo settings
                promoTitle: document.getElementById('promoTitleInput').value.trim() || defaultHeroSettings.promoTitle,
                promoSubtitle: document.getElementById('promoSubtitleInput').value.trim() || defaultHeroSettings.promoSubtitle,
                promoEmoji: document.getElementById('promoEmojiInput').value.trim() || defaultHeroSettings.promoEmoji,
                promoImageUrl: document.getElementById('promoImageUrl').value.trim(),
                promoColorFrom: document.getElementById('promoColorFrom').value || 'orange-400',
                promoColorTo: document.getElementById('promoColorTo').value || 'orange-500'
            };
            
            localStorage.setItem('varshaHeroSettings', JSON.stringify(heroSettings));
            await saveToFirebase('settings', 'hero', heroSettings);
            applyHeroSettings();
            showToast('Pengaturan Hero berhasil disimpan! ‚úì');
        }

        function applyHeroSettings() {
            // === HERO BANNER ===
            const heroBanner = document.getElementById('heroBanner');
            const heroEmoji = document.getElementById('heroEmoji');
            const heroTitleDisplay = document.getElementById('heroTitleDisplay');
            const heroSubtitleDisplay = document.getElementById('heroSubtitleDisplay');
            
            const overlay = (heroSettings.overlay || 40) / 100;
            
            // Apply hero banner styles with background image or gradient
            if (heroBanner) {
                if (heroSettings.imageUrl) {
                    // Full background image with dark overlay
                    heroBanner.style.backgroundImage = `linear-gradient(rgba(0,0,0,${overlay}), rgba(0,0,0,${overlay})), url('${heroSettings.imageUrl}')`;
                    heroBanner.style.backgroundSize = 'cover';
                    heroBanner.style.backgroundPosition = 'center';
                    heroBanner.className = 'rounded-2xl p-6 mb-6 text-white relative overflow-hidden min-h-[180px] flex flex-col justify-center';
                } else {
                    // Default gradient (green) when no image
                    heroBanner.style.backgroundImage = '';
                    heroBanner.style.backgroundSize = '';
                    heroBanner.style.backgroundPosition = '';
                    heroBanner.className = 'bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-6 mb-6 text-white relative overflow-hidden';
                }
            }
            
            // Apply hero emoji (only show if no image)
            if (heroEmoji) {
                if (heroSettings.imageUrl) {
                    heroEmoji.style.display = 'none';
                } else {
                    heroEmoji.style.display = 'block';
                    heroEmoji.textContent = 'üçá';
                    heroEmoji.className = 'absolute right-0 top-0 opacity-20 text-9xl';
                }
            }
            
            // Apply hero title and subtitle
            if (heroTitleDisplay) heroTitleDisplay.textContent = heroSettings.title || defaultHeroSettings.title;
            if (heroSubtitleDisplay) heroSubtitleDisplay.textContent = heroSettings.subtitle || defaultHeroSettings.subtitle;
            
            // === PROMO BANNER ===
            const promoBanner = document.getElementById('promoBanner');
            const promoDecor = document.getElementById('promoDecor');
            const promoTitleEl = document.getElementById('promoTitle');
            const promoSubtitleEl = document.getElementById('promoSubtitle');
            
            // Apply promo banner styles with background image or gradient
            if (promoBanner) {
                if (heroSettings.promoImageUrl) {
                    // Full background image
                    promoBanner.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.5)), url('${heroSettings.promoImageUrl}')`;
                    promoBanner.style.backgroundSize = 'cover';
                    promoBanner.style.backgroundPosition = 'center';
                    promoBanner.className = 'rounded-2xl p-5 mt-6 text-white relative overflow-hidden min-h-[120px] flex flex-col justify-center';
                } else {
                    // Gradient only
                    promoBanner.style.backgroundImage = '';
                    promoBanner.style.backgroundSize = '';
                    promoBanner.style.backgroundPosition = '';
                    promoBanner.className = `bg-gradient-to-r from-${heroSettings.promoColorFrom || 'orange-400'} to-${heroSettings.promoColorTo || 'orange-500'} rounded-2xl p-5 mt-6 text-white relative overflow-hidden`;
                }
            }
            
            // Apply promo emoji (only show if no image)
            if (promoDecor) {
                if (heroSettings.promoImageUrl) {
                    promoDecor.style.display = 'none';
                } else {
                    promoDecor.style.display = 'block';
                    promoDecor.textContent = heroSettings.promoEmoji || 'üçä';
                    promoDecor.className = 'absolute right-2 bottom-2 opacity-30 text-7xl';
                }
            }
            
            // Apply promo title and subtitle
            if (promoTitleEl) promoTitleEl.textContent = heroSettings.promoTitle || defaultHeroSettings.promoTitle;
            if (promoSubtitleEl) promoSubtitleEl.textContent = heroSettings.promoSubtitle || defaultHeroSettings.promoSubtitle;
        }

        // Firebase Config Functions
        function loadFirebaseConfigToForm() {
            document.getElementById('fbApiKey').value = firebaseConfig.apiKey || '';
            document.getElementById('fbAuthDomain').value = firebaseConfig.authDomain || '';
            document.getElementById('fbProjectId').value = firebaseConfig.projectId || '';
            document.getElementById('fbStorageBucket').value = firebaseConfig.storageBucket || '';
            document.getElementById('fbMessagingSenderId').value = firebaseConfig.messagingSenderId || '';
            document.getElementById('fbAppId').value = firebaseConfig.appId || '';
        }

        async function saveFirebaseConfig() {
            const newConfig = {
                apiKey: document.getElementById('fbApiKey').value.trim(),
                authDomain: document.getElementById('fbAuthDomain').value.trim(),
                projectId: document.getElementById('fbProjectId').value.trim(),
                storageBucket: document.getElementById('fbStorageBucket').value.trim(),
                messagingSenderId: document.getElementById('fbMessagingSenderId').value.trim(),
                appId: document.getElementById('fbAppId').value.trim()
            };
            
            if (!newConfig.apiKey || !newConfig.projectId) {
                showToast('API Key dan Project ID wajib diisi!');
                return;
            }
            
            firebaseConfig = newConfig;
            localStorage.setItem('varshaFirebaseConfig', JSON.stringify(firebaseConfig));
            
            showToast('Konfigurasi disimpan, menghubungkan ulang...');
            
            // Reinitialize Firebase
            try {
                if (firebase.apps.length) {
                    await firebase.app().delete();
                }
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                await loadFromFirebase();
                showToast('Berhasil terhubung ke Firebase! ‚úì');
            } catch (e) {
                console.error('Reconnect error:', e);
                showToast('Gagal menghubungkan: ' + e.message);
            }
        }

        function resetToDefault() {
            if (!confirm('Reset semua data ke default? Data lokal akan dihapus!')) return;
            
            localStorage.removeItem('varshaProducts');
            localStorage.removeItem('varshaSettings');
            localStorage.removeItem('varshaStoreProfile');
            localStorage.removeItem('varshaHeroSettings');
            localStorage.removeItem('varshaCarts');
            
            products = [...defaultProducts];
            settings = { waNumber: '6281234567890', pin: atob('MjkwNzA3') };
            storeProfile = { ...defaultStoreProfile };
            heroSettings = { ...defaultHeroSettings };
            
            renderAll();
            applyHeroSettings();
            showToast('Data berhasil direset ke default! ‚úì');
        }

        // Bulk Upload Functions
        function importFromExcel() {
            document.getElementById('excelFileInput').click();
        }

        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Skip header row if it looks like headers
                    let startRow = 0;
                    if (jsonData.length > 0) {
                        const firstRow = jsonData[0];
                        if (firstRow[0] && (firstRow[0].toString().toLowerCase().includes('nama') || firstRow[0].toString().toLowerCase().includes('name'))) {
                            startRow = 1;
                        }
                    }
                    
                    // Convert to tab-separated text
                    const textData = jsonData.slice(startRow)
                        .filter(row => row.length >= 4 && row[0]) // At least 4 columns and has name
                        .map(row => row.join('\t'))
                        .join('\n');
                    
                    document.getElementById('bulkProductData').value = textData;
                    showToast(`${jsonData.length - startRow} baris data dimuat dari Excel`);
                } catch (error) {
                    console.error('Excel parse error:', error);
                    showToast('Gagal membaca file Excel!');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset input
        }

        async function processBulkUpload() {
            const textData = document.getElementById('bulkProductData').value.trim();
            if (!textData) {
                showToast('Data produk kosong!');
                return;
            }

            const lines = textData.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                showToast('Tidak ada data untuk diupload!');
                return;
            }

            let successCount = 0;
            let errorCount = 0;
            const newProducts = [];

            // Get next ID
            let nextId = products.length > 0 ? Math.max(...products.map(p => parseInt(p.id) || 0)) + 1 : 1;

            for (const line of lines) {
                // Split by tab or multiple spaces
                const cols = line.split(/\t/).map(c => c.trim());
                
                if (cols.length < 4) {
                    errorCount++;
                    continue;
                }

                const [name, priceStr, unit, category, image, desc] = cols;
                const price = parseInt(priceStr.replace(/\D/g, ''));

                if (!name || !price || !unit || !category) {
                    errorCount++;
                    continue;
                }

                // Validate category
                const validCategories = ['Buah', 'Sayuran', 'Bumbu', 'Lainnya'];
                const normalizedCategory = validCategories.find(c => 
                    c.toLowerCase() === category.toLowerCase()
                ) || 'Lainnya';

                const newProduct = {
                    id: nextId.toString(),
                    name: name,
                    price: price,
                    unit: unit,
                    category: normalizedCategory,
                    image: image || 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(name),
                    desc: desc || name
                };

                newProducts.push(newProduct);
                nextId++;
                successCount++;
            }

            if (newProducts.length === 0) {
                showToast('Tidak ada produk valid untuk diupload!');
                return;
            }

            // Add to products array and save to Firebase
            showToast(`Mengupload ${newProducts.length} produk...`);
            
            for (const p of newProducts) {
                products.push(p);
                await saveToFirebase('products', p.id, {
                    name: p.name,
                    price: p.price,
                    unit: p.unit,
                    category: p.category,
                    image: p.image,
                    desc: p.desc
                });
            }

            // Clear textarea
            document.getElementById('bulkProductData').value = '';

            // Update UI
            renderAdminProductList();
            renderProducts();
            renderFeaturedProducts();

            showToast(`‚úì ${successCount} produk berhasil diupload!${errorCount > 0 ? ` (${errorCount} gagal)` : ''}`);
        }

        // Delete Data Functions
        async function deleteAllProducts() {
            showConfirmModal({
                title: 'üóëÔ∏è Hapus Semua Produk?',
                message: `
                    <div class="space-y-2">
                        <p class="font-medium text-gray-800">Anda akan menghapus:</p>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>${products.length} produk</strong> dari katalog</li>
                            <li>Data produk di Firebase</li>
                        </ul>
                    </div>
                `,
                warning: 'Data yang dihapus tidak dapat dikembalikan!',
                icon: 'fas fa-box',
                iconBg: 'bg-orange-100',
                btnText: 'Hapus Produk',
                btnClass: 'bg-red-500 hover:bg-red-600',
                onConfirm: async () => {
                    showToast('Menghapus produk...');
                    try {
                        if (db && isFirebaseConnected) {
                            for (const p of products) {
                                await db.collection('products').doc(p.id.toString()).delete();
                            }
                        }
                        products = [];
                        localStorage.removeItem('varshaProducts');
                        renderProducts();
                        renderFeaturedProducts();
                        renderAdminProductList();
                        showToast('‚úì Semua produk berhasil dihapus!');
                    } catch (e) {
                        console.error('Delete products error:', e);
                        showToast('Gagal menghapus: ' + e.message);
                    }
                }
            });
        }

        async function deleteAllOrders() {
            showConfirmModal({
                title: 'üóëÔ∏è Hapus Semua Pesanan?',
                message: `
                    <div class="space-y-2">
                        <p class="font-medium text-gray-800">Anda akan menghapus:</p>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>${orders.length} pesanan</strong> dari database</li>
                            <li>Riwayat semua transaksi</li>
                        </ul>
                    </div>
                `,
                warning: 'Semua riwayat pesanan akan hilang permanen!',
                icon: 'fas fa-clipboard-list',
                iconBg: 'bg-blue-100',
                btnText: 'Hapus Pesanan',
                btnClass: 'bg-red-500 hover:bg-red-600',
                onConfirm: async () => {
                    showToast('Menghapus pesanan...');
                    try {
                        if (db && isFirebaseConnected) {
                            for (const o of orders) {
                                await db.collection('orders').doc(o.id).delete();
                            }
                        }
                        orders = [];
                        renderAdminOrders();
                        renderCustomerOrders();
                        updateOrderBadge();
                        showToast('‚úì Semua pesanan berhasil dihapus!');
                    } catch (e) {
                        console.error('Delete orders error:', e);
                        showToast('Gagal menghapus: ' + e.message);
                    }
                }
            });
        }

        async function deleteAllCustomers() {
            showConfirmModal({
                title: 'üóëÔ∏è Hapus Semua Customer?',
                message: `
                    <div class="space-y-2">
                        <p class="font-medium text-gray-800">Anda akan menghapus:</p>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>${customers.length} customer</strong> dari database</li>
                            <li>Semua data pelanggan terdaftar</li>
                            <li>Semua keranjang belanja</li>
                        </ul>
                    </div>
                `,
                warning: 'Customer yang sudah terdaftar harus mendaftar ulang!',
                icon: 'fas fa-users',
                iconBg: 'bg-purple-100',
                btnText: 'Hapus Customer',
                btnClass: 'bg-red-500 hover:bg-red-600',
                onConfirm: async () => {
                    showToast('Menghapus customer...');
                    try {
                        if (db && isFirebaseConnected) {
                            for (const c of customers) {
                                await db.collection('customers').doc(c.id).delete();
                            }
                        }
                        customers = [];
                        currentCustomer = null;
                        localStorage.removeItem('varshaCurrentCustomer');
                        localStorage.removeItem('varshaCarts');
                        renderAdminCustomers();
                        updateCustomerBar();
                        renderCart();
                        showToast('‚úì Semua customer berhasil dihapus!');
                    } catch (e) {
                        console.error('Delete customers error:', e);
                        showToast('Gagal menghapus: ' + e.message);
                    }
                }
            });
        }

        async function deleteAllData() {
            showConfirmModal({
                title: '‚ö†Ô∏è HAPUS SEMUA DATA?',
                message: `
                    <div class="space-y-3">
                        <p class="font-medium text-gray-800">Anda akan menghapus SEMUA data:</p>
                        <div class="bg-white rounded-lg p-3 border border-gray-200">
                            <ul class="space-y-2 text-sm">
                                <li class="flex items-center gap-2">
                                    <span class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-box text-orange-500 text-xs"></i>
                                    </span>
                                    <span><strong>${products.length}</strong> Produk</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-clipboard-list text-blue-500 text-xs"></i>
                                    </span>
                                    <span><strong>${orders.length}</strong> Pesanan</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-users text-purple-500 text-xs"></i>
                                    </span>
                                    <span><strong>${customers.length}</strong> Customer</span>
                                </li>
                            </ul>
                        </div>
                        <p class="text-xs text-gray-500">* Pengaturan toko akan tetap tersimpan</p>
                    </div>
                `,
                warning: 'PERINGATAN: Tindakan ini TIDAK DAPAT dibatalkan! Semua data akan hilang secara permanen.',
                icon: 'fas fa-exclamation-triangle',
                iconBg: 'bg-red-100',
                btnText: 'HAPUS SEMUA',
                btnClass: 'bg-red-600 hover:bg-red-700',
                onConfirm: async () => {
                    showToast('Menghapus semua data...');
                    try {
                        if (db && isFirebaseConnected) {
                            for (const p of products) {
                                await db.collection('products').doc(p.id.toString()).delete();
                            }
                            for (const o of orders) {
                                await db.collection('orders').doc(o.id).delete();
                            }
                            for (const c of customers) {
                                await db.collection('customers').doc(c.id).delete();
                            }
                        }
                        localStorage.clear();
                        products = [];
                        orders = [];
                        customers = [];
                        currentCustomer = null;
                        renderAll();
                        updateCustomerBar();
                        showToast('‚úì Semua data berhasil dihapus!');
                        setTimeout(() => location.reload(), 1500);
                    } catch (e) {
                        console.error('Delete all data error:', e);
                        showToast('Gagal menghapus: ' + e.message);
                    }
                }
            });
        }

        // Navigation
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            if (page === 'keranjang') renderCart();
            if (page === 'katalog') renderProducts();
            if (page === 'pesanan') {
                renderCustomerOrders();
                updateOrderBadge();
            }
            window.scrollTo(0, 0);
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            if (event?.currentTarget) event.currentTarget.classList.add('active');
            renderProducts();
            navigateTo('katalog');
        }

        function showSearch() {
            document.getElementById('searchBar').classList.remove('hidden');
            document.getElementById('searchInput').focus();
        }

        function hideSearch() {
            document.getElementById('searchBar').classList.add('hidden');
            document.getElementById('searchInput').value = '';
            renderProducts();
        }

        function searchProducts() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            renderProducts(products.filter(p => p.name.toLowerCase().includes(query)));
            navigateTo('katalog');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2500);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('productImage').addEventListener('input', function() {
                const preview = document.getElementById('imagePreview');
                const img = document.getElementById('previewImg');
                if (this.value.startsWith('http')) {
                    img.src = this.value;
                    preview.classList.remove('hidden');
                } else {
                    preview.classList.add('hidden');
                }
            });
            setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 1000);
        });
    </script>
</body>
</html>
